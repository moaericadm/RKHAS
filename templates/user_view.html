{% extends "base.html" %}
{% block title %}Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‚Ø§Ø·{% endblock %}
{% block header_title %}Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²ÙˆØ§Ø­Ù Ø§Ù„Ø±Ø³Ù…ÙŠØ© (ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø±){% endblock %}

{% block styles %}
<style>
    .table thead th {
        background-color: var(--primary-glow) !important;
        color: white !important;
        text-shadow: 0 0 5px rgba(0,0,0,0.5);
        border-color: var(--primary-glow) !important;
    }

    html:not(.dark-mode) .table thead th {
        background-color: var(--header-color) !important;
    }

    .like-btn.liked {
        background-color: #dc3545;
        color: white;
        border-color: #dc3545;
    }

    /* --- SPIN WHEEL STYLES --- */
    #spin-wheel-card .card-body {
        background-image: linear-gradient(45deg, rgba(255, 215, 0, 0.1), transparent), linear-gradient(-45deg, rgba(0, 242, 255, 0.1), transparent);
    }

    #spin-wheel-btn {
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 0 20px var(--secondary-glow);
    }

        #spin-wheel-btn:disabled {
            box-shadow: none;
        }

    #spin-timer {
        font-family: monospace;
        font-size: 1.1rem;
        color: var(--secondary-glow);
        text-shadow: 0 0 8px var(--secondary-glow);
    }

    #spinWheelModal .custom-modal-content {
        max-width: 480px;
        padding: 15px;
        background-color: transparent;
        border: none;
        box-shadow: none;
    }

    #spin-canvas {
        display: block;
        margin: 0 auto;
        max-width: 100%;
        height: auto;
    }
    /* --- END SPIN WHEEL STYLES --- */

    .custom-modal {
        display: none;
        position: fixed;
        z-index: 1060;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        background-color: rgba(11, 2, 29, 0.9);
        backdrop-filter: blur(8px);
        align-items: center;
        justify-content: center;
    }

        .custom-modal.show {
            display: flex;
        }

    .custom-modal-content:not(#spinWheelModal .custom-modal-content) {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        margin: 1rem;
        padding: 30px;
        width: 90%;
        max-width: 600px;
        border-radius: 0.75rem;
        position: relative;
        animation: modal-fade-in 0.3s ease-out;
    }

    @keyframes modal-fade-in {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .custom-close-btn {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
        z-index: 1070;
    }

        .custom-close-btn:hover {
            color: #fff;
        }


    .ticker-wrap {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        padding: 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .ticker-title {
        background-color: var(--primary-glow);
        color: white;
        padding: 5px 15px;
        border-radius: 5px;
        font-weight: bold;
        flex-shrink: 0;
    }

    .ticker-container {
        flex-grow: 1;
        overflow: hidden;
        position: relative;
        min-height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ticker-item {
        color: var(--text-color);
        font-weight: bold;
        position: absolute;
        width: 100%;
        text-align: center;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out;
        will-change: opacity, transform;
    }

        .ticker-item.active {
            opacity: 1;
            transform: translateY(0);
            z-index: 1;
        }

    .duel-select {
        background-color: var(--bs-body-bg) !important;
        color: var(--bs-body-color) !important;
        border-color: var(--card-border) !important;
    }

    .duel-arena {
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        height: 250px;
        padding-top: 20px;
        overflow: hidden;
    }

    .fighter {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .fighter-name {
        font-weight: bold;
        font-size: 1.2rem;
        margin-bottom: 10px;
        color: var(--primary-glow);
    }

    .fighter-icon {
        font-size: 6rem;
        line-height: 1;
        color: var(--text-color);
    }

    .health-bar-container {
        width: 120px;
        height: 15px;
        background-color: #444;
        border-radius: 5px;
        margin-bottom: 10px;
        overflow: hidden;
        border: 1px solid #666;
    }

    .health-bar {
        height: 100%;
        width: 100%;
        background: linear-gradient(90deg, #14f195, #00f2ff);
        border-radius: 4px;
        transition: width 2s ease-in-out;
    }

    .vs-text {
        font-size: 4rem;
        font-weight: 800;
        color: #ffc107;
        align-self: center;
        text-shadow: 0 0 10px #ffc107;
    }

    #duel-result-text {
        font-size: 1.5rem;
        font-weight: bold;
        margin-top: 20px;
        height: 3rem;
    }

    .fighter.fighting .fighter-icon {
        animation: shake 0.4s infinite;
    }

    @keyframes shake {
        0% {
            transform: translate(1px,1px)
        }

        25% {
            transform: translate(-1px,-2px)
        }

        50% {
            transform: translate(-3px,0)
        }

        75% {
            transform: translate(3px,2px)
        }

        100% {
            transform: translate(1px,-1px)
        }
    }

    #crawl-chart-container {
        position: relative;
        height: 250px;
        width: 250px;
        margin: auto;
    }

    #userChartModal .custom-modal-content {
        max-width: 800px;
    }

    #user-chart-container {
        height: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div id="announcements-container" class="row justify-content-center mb-4" style="display: none;">
    <div class="col-lg-12">
        <div class="ticker-wrap">
            <div class="d-flex align-items-center">
                <div class="ticker-title">Ø¹Ø§Ø¬Ù„</div>
                <div class="ticker-container" id="announcements-ticker">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card shadow-lg h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-bar-chart-line-fill me-2"></i>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø²ÙˆØ§Ø­Ù</span>
                <input type="search" id="searchInput" class="form-control form-control-sm w-50" placeholder="ğŸ” Ø§Ø¨Ø­Ø«..." />
            </div>
            <div class="card-body table-responsive">
                <table class="table table-hover align-middle">
                    <thead><tr><th>#</th><th> Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø­Ù  </th><th class="text-center">Ø§Ù„Ù†Ù‚Ø§Ø·</th><th class="text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                    <tbody id="user-table-body">
                        <tr>
                            <td colspan="4" class="text-center py-5">
                                <div id="loading-spinner">
                                    <div class="spinner-border text-danger"></div>
                                    <p class="mt-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø²Ø­Ù...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="vstack gap-4">

            <div class="card shadow-lg" id="spin-wheel-card" style="display: none;">
                <div class="card-header text-warning"><i class="bi bi-bullseye me-2"></i>Ø¹Ø¬Ù„Ø© Ø­Ø¸ Ø§Ù„Ø²ÙˆØ§Ø­Ù</div>
                <div class="card-body text-center">
                    <p class="text-muted small mb-3">Ø¬Ø±Ù‘Ø¨ Ø­Ø¸Ùƒ Ù…Ø±Ø© ÙƒÙ„ 24 Ø³Ø§Ø¹Ø© Ù„Ù„ÙÙˆØ² Ø¨Ù†Ù‚Ø§Ø· ÙˆØ§Ù„ØªØ¨Ø±Ø¹ Ø¨Ù‡Ø§!</p>
                    <div class="d-grid">
                        <button class="btn btn-info" id="spin-wheel-btn"><i class="bi bi-arrow-repeat me-2"></i>Ù„Ù Ø§Ù„Ø¹Ø¬Ù„Ø© Ø§Ù„Ø¢Ù†!</button>
                    </div>
                    <div id="spin-timer-container" style="display: none;">
                        <p class="mb-1 mt-3">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù„Ù Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯:</p>
                        <div id="spin-timer" class="fw-bold">--:--:--</div>
                    </div>
                </div>
            </div>

            <div class="card shadow-lg">
                <div class="card-header"><i class="bi bi-speedometer2 me-2 text-info"></i>ÙƒØ§Ø´Ù Ø§Ù„Ø²ÙˆØ§Ø­Ù</div>
                <div class="card-body">
                    <p class="text-muted small">Ù‡Ù„ Ø£Ù†Øª Ø²Ø§Ø­ÙØŸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ§ÙƒØªØ´Ù Ù†Ø³Ø¨Ø© Ø²Ø­ÙÙƒ!</p>
                    <div class="input-group">
                        <input type="text" id="crawl-name-input" class="form-control form-control-sm" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ø§Ù‹...">
                        <button id="check-crawl-btn" class="btn btn-info btn-sm">Ø§ÙØ­Øµ Ø§Ù„Ø²Ø­ÙÙ†Ø©</button>
                    </div>
                </div>
            </div>

            <div class="card shadow-lg">
                <div class="card-header"><i class="bi bi-lightning-charge-fill text-warning me-2"></i>Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø­Ù</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label for="duel-user1" class="form-label small">Ø§Ù„Ø²Ø§Ø­Ù Ø§Ù„Ø£ÙˆÙ„</label>
                        <select id="duel-user1" class="form-select form-select-sm duel-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="duel-user2" class="form-label small">Ø§Ù„Ø²Ø§Ø­Ù Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
                        <select id="duel-user2" class="form-select form-select-sm duel-select"></select>
                    </div>
                    <div class="d-grid">
                        <button id="start-duel-btn" class="btn btn-warning btn-sm">Ø¨Ø¯Ø¡ Ù…ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø²Ø­ÙÙ†Ø©!</button>
                    </div>
                </div>
            </div>

            <div class="card shadow-lg"><div class="card-header bg-warning text-dark"><i class="bi bi-trophy-fill me-2"></i>ØªÙˆØ¨ 3 Ø²ÙˆØ§Ø­Ù</div><ul class="list-group list-group-flush" id="hall-of-fame"></ul></div>
            <div class="card shadow-lg"><div class="card-header" style="background: var(--primary-glow); color: #fff;"><i class="bi bi-award-fill me-2"></i> Ø§Ù„Ø²Ø§Ø­Ù Ø§Ù„Ø§ÙƒØ«Ø± Ø°ÙƒØ±Ø§Ù‹</div><ul class="list-group list-group-flush" id="honor-roll-view-list"></ul></div>
            <div class="card shadow-lg"><div class="card-header"><i class="bi bi-person-check-fill me-2 text-success"></i>Ù…Ø±Ø´Ø­ÙˆÙ† Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© </div><ul class="list-group list-group-flush" id="candidates-list"></ul></div>
            <div class="card shadow-lg"><div class="card-header"><i class="bi bi-joystick me-2"></i>ØªÙØ§Ø¹Ù„ Ù…Ø¹Ù†Ø§</div><div class="card-body d-grid gap-2"><button class="btn btn-success" id="nominate-btn"><i class="bi bi-person-up me-2"></i>Ø±Ø´Ø­ Ø§Ø­Ø¯Ø§Ù‹</button><button class="btn btn-outline-danger" id="report-btn"><i class="bi bi-exclamation-triangle-fill me-2"></i>Ø£Ø¨Ù„Øº Ø¹Ù† Ø²Ø§Ø­Ù</button></div></div>
        </div>
    </div>
</div>

<div id="spinWheelModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="custom-close-btn">Ã—</span>
        <canvas id="spin-canvas" width="450" height="450">
            <p>Ø¹Ø°Ø±Ø§Ù‹, Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© (Canvas).</p>
        </canvas>
    </div>
</div>

<div id="userChartModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="custom-close-btn">Ã—</span>
        <h5 class="mb-3" id="chartModalLabel">Ø³Ø¬Ù„ Ù†Ù‚Ø§Ø· Ø§Ù„Ø²ÙˆØ§Ø­Ù</h5>
        <div id="user-chart-container">
            <canvas id="userPointsChart"></canvas>
        </div>
    </div>
</div>

<div id="duelModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="custom-close-btn">Ã—</span>
        <h3 class="mb-4 text-center">Ø­Ù„Ø¨Ø© Ø§Ù„Ø²Ø­ÙÙ†Ø©</h3>
        <div class="duel-arena">
            <div class="fighter" id="fighter1">
                <div class="fighter-name">Ø§Ù„Ø²Ø§Ø­Ù 1</div>
                <div class="health-bar-container"><div class="health-bar"></div></div>
                <i class="bi bi-person-arms-up fighter-icon"></i>
            </div>
            <div class="vs-text">VS</div>
            <div class="fighter" id="fighter2">
                <div class="fighter-name">Ø§Ù„Ø²Ø§Ø­Ù 2</div>
                <div class="health-bar-container"><div class="health-bar"></div></div>
                <i class="bi bi-person-raised-hand fighter-icon"></i>
            </div>
        </div>
        <div id="duel-result-text" class="text-center text-warning mt-3"></div>
    </div>
</div>

<div id="crawlModal" class="custom-modal">
    <div class="custom-modal-content text-center">
        <span class="custom-close-btn">Ã—</span>
        <h3 class="mb-3" id="crawl-modal-title">Ù†ØªÙŠØ¬Ø© ÙØ­Øµ Ø§Ù„Ø²Ø­ÙÙ†Ø©</h3>
        <div id="crawl-chart-container">
            <canvas id="crawlChart"></canvas>
        </div>
        <p id="crawl-modal-text" class="fs-5 mt-3 fw-bold"></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Use CDN for reliability -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/TweenMax.min.js"></script>
<script src="{{ url_for('static', filename='js/Winwheel.min.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ui = {
        tableBody: document.getElementById('user-table-body'),
        loadingSpinner: document.getElementById('loading-spinner'),
        hallOfFame: document.getElementById('hall-of-fame'),
        honorRollList: document.getElementById('honor-roll-view-list'),
        candidatesList: document.getElementById('candidates-list'),
        searchInput: document.getElementById('searchInput'),
        nominateBtn: document.getElementById('nominate-btn'),
        reportBtn: document.getElementById('report-btn'),
        userChartModal: document.getElementById('userChartModal'),
        chartModalLabel: document.getElementById('chartModalLabel'),
        userPointsChartCanvas: document.getElementById('userPointsChart'),
        duelModal: document.getElementById('duelModal'),
        duelUser1Select: document.getElementById('duel-user1'),
        duelUser2Select: document.getElementById('duel-user2'),
        startDuelBtn: document.getElementById('start-duel-btn'),
        fighter1Name: document.querySelector('#fighter1 .fighter-name'),
        fighter2Name: document.querySelector('#fighter2 .fighter-name'),
        fighter1Health: document.querySelector('#fighter1 .health-bar'),
        fighter2Health: document.querySelector('#fighter2 .health-bar'),
        fighter1Div: document.getElementById('fighter1'),
        fighter2Div: document.getElementById('fighter2'),
        duelResultText: document.getElementById('duel-result-text'),
        crawlModal: document.getElementById('crawlModal'),
        crawlNameInput: document.getElementById('crawl-name-input'),
        checkCrawlBtn: document.getElementById('check-crawl-btn'),
        crawlModalTitle: document.getElementById('crawl-modal-title'),
        crawlChartCanvas: document.getElementById('crawlChart'),
        crawlModalText: document.getElementById('crawl-modal-text'),
        announcementsContainer: document.getElementById('announcements-container'),
        announcementsTicker: document.getElementById('announcements-ticker'),
        spinWheel: {
            card: document.getElementById('spin-wheel-card'),
            btn: document.getElementById('spin-wheel-btn'),
            timerContainer: document.getElementById('spin-timer-container'),
            timer: document.getElementById('spin-timer'),
            modal: document.getElementById('spinWheelModal'),
            canvas: document.getElementById('spin-canvas'),
            modalCloseBtn: document.querySelector('#spinWheelModal .custom-close-btn')
        }
    };

    let allUsersCache = [], honorRollCache = [], candidatesCache = [], announcementsCache = [];
    let userChartInstance = null, crawlChartInstance = null;
    let visitorName = '';
    let announcementInterval = null;
    let theWheel = null;
    let wheelSpinning = false;
    let cooldownInterval = null;
    let dbInstance = null;

    const formatNumber = (num) => new Intl.NumberFormat('ar-EG').format(num || 0);
    const sessionProcessedMessageIds = new Set();
    const viewedMessages = {
        get: () => { try { return new Set(JSON.parse(localStorage.getItem('viewedMessageIds')) || []); } catch { return new Set(); } },
        add: (id) => { const ids = viewedMessages.get(); ids.add(id); localStorage.setItem('viewedMessageIds', JSON.stringify([...ids])); }
    };

    async function initializeApp() {
        try {
            visitorName = localStorage.getItem('visitorNickname');
            if (!visitorName) {
                const { value: name } = await Swal.fire({
                    title: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!', input: 'text', inputLabel: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ¹Ø§Ø± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ùˆ Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù‚Ø·Ø© ( . ) ÙƒØ§Ø³Ù… Ø§Ùˆ Ø§ÙŠ Ù„ÙØ¸ Ø³ÙŠØ¡ ØªØ¬Ù†Ø¨Ø§Ù‹ Ù„Ù„Ø­Ø¸Ø±',
                    inputPlaceholder: 'Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±...', allowOutsideClick: false, allowEscapeKey: false,
                    inputValidator: (v) => !v && 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…!'
                });
                if (name) { visitorName = name.trim(); localStorage.setItem('visitorNickname', visitorName); }
                else { window.location.reload(); return; }
            }

            const banStatusRes = await fetch(`/api/check_ban_status/${visitorName}`);
            if (!banStatusRes.ok) throw new Error(`Ban status check failed: ${banStatusRes.status}`);
            const banStatus = await banStatusRes.json();
            if(banStatus.is_banned) {
                document.body.innerHTML = `<div class="container text-center mt-5"><div class="card p-5"><h1 class="text-danger">Ù„Ù‚Ø¯ ØªÙ… Ø­Ø¸Ø±Ùƒ</h1><p class="fs-5">ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø¯Ø§Ø±Ø© Ø¨ØªØ³Ø¨ Ø¹Ù„ÙŠÙ†Ø§ ÙŠØ§ Ø¹Ø§ÙŠØ¨ .</p></div></div>`;
                return;
            }

            const configStr = '{{ firebase_config|tojson|safe }}';
            if (!configStr || configStr === '{}' || configStr.trim() === "") {
                throw new Error("Firebase config is missing or empty in the template.");
            }
            let firebaseConfig;
            try { firebaseConfig = JSON.parse(configStr); }
            catch (jsonError) { throw new Error("Firebase config is malformed. Cannot parse as JSON."); }
            if (!firebaseConfig.apiKey) {
                throw new Error("Firebase API key is missing in the parsed config.");
            }
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            dbInstance = firebase.database();

            setupEventListeners();

            // Check for libraries before initializing
            if (typeof Winwheel !== 'undefined' && typeof gsap !== 'undefined' && typeof TweenMax !== 'undefined') {
                initializeSpinWheel();
            } else {
                // Log which library is missing
                let missing = [];
                if(typeof Winwheel === 'undefined') missing.push('Winwheel');
                if(typeof gsap === 'undefined') missing.push('gsap');
                if(typeof TweenMax === 'undefined') missing.push('TweenMax');
                console.error(`${missing.join(', ')} library is not defined! Spin wheel will not work.`);

                if (ui.spinWheel.card) ui.spinWheel.card.innerHTML = '<p class="text-danger p-3">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸.</p>';
            }

            dbInstance.ref('users').on('value', handleUsersSnapshot, handleFirebaseError);
            dbInstance.ref('site_settings/honor_roll').on('value', handleHonorRollSnapshot, handleFirebaseError);
            dbInstance.ref('candidates').on('value', handleCandidatesSnapshot, handleFirebaseError);
            dbInstance.ref('site_settings/announcements').on('value', handleAnnouncementsSnapshot, handleFirebaseError);
            dbInstance.ref('site_settings/spin_wheel_enabled').on('value', handleSpinWheelSettingSnapshot, handleFirebaseError);
            dbInstance.ref(`visitor_messages/${visitorName}`).on('child_added', handleVisitorMessage, handleFirebaseError);

        } catch (e) {
            console.error("CRITICAL INITIALIZATION ERROR:", e.message, e.stack);
            const errorDisplayElement = (ui.loadingSpinner && ui.loadingSpinner.parentElement) || document.querySelector('.container') || document.body;
            if (errorDisplayElement) {
                 errorDisplayElement.innerHTML = `<div class="alert alert-danger m-3"><strong>Ø®Ø·Ø£ Ø­Ø±Ø¬:</strong> ${e.message} ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ø¹Ù….</div>`;
            }
        }
    }

    function handleFirebaseError(error) {
        console.error("Firebase Read Error:", error.code, error.message);
        const errorDisplayElement = (ui.loadingSpinner && ui.loadingSpinner.parentElement) || ui.tableBody || document.querySelector('.container');
        if (errorDisplayElement) {
            let errorMsg = `ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø±Ù…Ø²: ${error.code}. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.`;
            if (ui.tableBody && ui.tableBody === errorDisplayElement) {
                 ui.tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4"><div class="alert alert-warning">${errorMsg}</div></td></tr>`;
            } else if (errorDisplayElement.classList.contains('container')) {
                 const alertDiv = document.createElement('div');
                 alertDiv.className = 'alert alert-danger m-3';
                 alertDiv.innerHTML = errorMsg;
                 errorDisplayElement.prepend(alertDiv);
            }
        }
        if (ui.spinWheel.btn) ui.spinWheel.btn.disabled = true;
    }

    function handleVisitorMessage(snapshot) {
        const messageId = snapshot.key;
        const message = snapshot.val();
        if (!message || sessionProcessedMessageIds.has(messageId) || viewedMessages.get().has(messageId)) return;
        sessionProcessedMessageIds.add(messageId);
        viewedMessages.add(messageId);
        Swal.fire({ title: 'Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø´Ø±Ù!', text: message.text, icon: 'info', confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹' })
        .then(() => {
            snapshot.ref.remove().catch(err => console.error("Firebase: Failed to remove message", err));
        });
    }

    function handleUsersSnapshot(snapshot) {
        if (ui.loadingSpinner && ui.loadingSpinner.parentElement) ui.loadingSpinner.parentElement.style.display = 'none';
        const usersData = snapshot.val() || {};
        allUsersCache = Object.keys(usersData).map(k => ({ name: k, ...usersData[k] })).sort((a, b) => (b.points || 0) - (a.points || 0));
        renderUserTable();
        renderTop3();
        updateDuelSelectors();
    }

    function handleHonorRollSnapshot(snapshot) {
        const honorData = snapshot.val() || {};
        honorRollCache = Object.values(honorData).map(i => i.name);
        renderHonorRollList();
        if(allUsersCache.length > 0) renderUserTable();
    }

    function handleCandidatesSnapshot(snapshot) {
        candidatesCache = Object.keys(snapshot.val() || {});
        renderCandidatesList();
    }

    function handleAnnouncementsSnapshot(snapshot) {
        const annData = snapshot.val() || {};
        announcementsCache = Object.values(annData);
        renderAnnouncements();
    }

    function handleSpinWheelSettingSnapshot(snapshot) {
        const isEnabled = !!snapshot.val();
        if (ui.spinWheel.card) {
            ui.spinWheel.card.style.display = isEnabled ? 'block' : 'none';
            if (isEnabled) {
                checkSpinCooldown();
            } else {
                if (cooldownInterval) clearInterval(cooldownInterval);
            }
        }
    }

    function renderUserTable() {
        if (!ui.tableBody) return;
        const term = ui.searchInput.value.toLowerCase();
        const filteredUsers = allUsersCache.filter(u => u.name.toLowerCase().includes(term));
        let tableHtml = '';

        if (filteredUsers.length > 0) {
            filteredUsers.forEach((user) => {
                const rank = allUsersCache.findIndex(u => u.name === user.name) + 1;
                const honorBadge = honorRollCache.includes(user.name) ? ` <span class="badge rounded-pill" style="background:var(--primary-glow);color:#fff;"><i class="bi bi-award-fill"></i></span>` : '';
                const hasLiked = (new Set(JSON.parse(localStorage.getItem('likedUsers')) || [])).has(user.name);
                tableHtml += `
                    <tr>
                        <th class="align-middle">#${rank}</th>
                        <td class="align-middle fw-bold">${user.name}${honorBadge}</td>
                        <td class="text-center align-middle fs-5 fw-bold">${formatNumber(user.points)}</td>
                        <td class="text-center align-middle">
                            <button class="btn btn-sm like-btn ${hasLiked ? 'liked' : 'btn-outline-danger'}" data-username="${user.name}">
                                <i class="bi bi-heart-fill"></i> <span class="like-count">${formatNumber(user.likes)}</span>
                            </button>
                            <button class="btn btn-sm btn-outline-info ms-2 chart-btn" data-username="${user.name}" title="Ø¹Ø±Ø¶ ØªÙ‚Ø¯Ù… Ø§Ù„Ø²Ø§Ø­Ù">
                                <i class="bi bi-graph-up-arrow"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        } else {
            tableHtml = `<tr><td colspan="4" class="text-center py-4">${term ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø§Ø­Ù ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«.' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.'}</td></tr>`;
        }
        ui.tableBody.innerHTML = tableHtml;
    }

    function renderTop3() {
        if (!ui.hallOfFame) return;
        ui.hallOfFame.innerHTML = allUsersCache.slice(0, 3).map((u, i) =>
            `<li class="list-group-item d-flex justify-content-between"><span>${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]} ${u.name}</span><span class="badge rounded-pill" style="background-color:var(--primary-glow)">${formatNumber(u.points)}</span></li>`
        ).join('') || `<li class="list-group-item text-muted text-center">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©.</li>`;
    }

    function renderHonorRollList() {
        if (!ui.honorRollList) return;
        ui.honorRollList.innerHTML = honorRollCache.length ?
            honorRollCache.map(name => `<li class="list-group-item fw-bold text-center"><i class="bi bi-star-fill text-warning me-2"></i>${name}</li>`).join('') :
            `<li class="list-group-item text-muted text-center">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©.</li>`;
    }

    function renderCandidatesList() {
        if (!ui.candidatesList) return;
        ui.candidatesList.innerHTML = candidatesCache.length ?
            candidatesCache.map(name => `<li class="list-group-item"><i class="bi bi-person-check-fill me-2"></i>${name}</li>`).join('') :
            `<li class="list-group-item text-muted text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø´Ø­ÙˆÙ†.</li>`;
    }

    function renderAnnouncements() {
        if (!ui.announcementsTicker || !ui.announcementsContainer) return;
        ui.announcementsTicker.innerHTML = '';
        if (announcementInterval) clearInterval(announcementInterval);

        if (announcementsCache.length > 0) {
            ui.announcementsContainer.style.display = 'block';
            announcementsCache.forEach(ann => {
                const item = document.createElement('div');
                item.className = 'ticker-item';
                item.textContent = ann.text;
                ui.announcementsTicker.appendChild(item);
            });
            const items = ui.announcementsTicker.querySelectorAll('.ticker-item');
            if (items.length === 0) return;

            let currentIndex = 0;
            if(items[currentIndex]) items[currentIndex].classList.add('active');

            if (items.length > 1) {
                announcementInterval = setInterval(() => {
                    if(items[currentIndex]) items[currentIndex].classList.remove('active');
                    currentIndex = (currentIndex + 1) % items.length;
                    if(items[currentIndex]) items[currentIndex].classList.add('active');
                }, 5000);
            }
        } else {
            ui.announcementsContainer.style.display = 'none';
        }
    }

    function updateDuelSelectors() {
        if (!ui.duelUser1Select || !ui.duelUser2Select) return;
        const options = allUsersCache.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
        ui.duelUser1Select.innerHTML = options;
        ui.duelUser2Select.innerHTML = options;
        if (allUsersCache.length > 1 && ui.duelUser2Select.options.length > 1) {
            ui.duelUser2Select.selectedIndex = 1;
        } else if (allUsersCache.length === 1 && ui.duelUser2Select.options.length > 0) {
            ui.duelUser2Select.selectedIndex = 0;
        }
    }

    function initializeSpinWheel() {
        if (!ui.spinWheel.canvas || typeof Winwheel === 'undefined' || typeof TweenMax === 'undefined') {
            const errorMsg = "ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸. Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.";
            console.error(errorMsg);
            if (ui.spinWheel.card) ui.spinWheel.card.innerHTML = `<p class="text-danger p-3">${errorMsg}</p>`;
            return;
        }

        const segmentsWithMillion = [
            {'fillStyle' : '#eae56f', 'text' : '100', 'textFillStyle' : '#000'},
            {'fillStyle' : '#7de6ef', 'text' : '250', 'textFillStyle' : '#000'},
            {'fillStyle' : '#89f26e', 'text' : '500', 'textFillStyle' : '#000'},
            {'fillStyle' : '#e7706f', 'text' : '1000'},
            {'fillStyle' : '#FFD700', 'text' : 'Ù…Ù„ÙŠÙˆÙ†!', 'textFillStyle' : '#000'},
            {'fillStyle' : '#c789f2', 'text' : '2500'},
            {'fillStyle' : '#f2a15f', 'text' : '5000'},
            {'fillStyle' : '#6aaff2', 'text' : '10000'},
            {'fillStyle' : '#f289b4', 'text' : '50000'}
        ];

        try {
            theWheel = new Winwheel({
                'canvasId'      : ui.spinWheel.canvas.id,
                'numSegments'   : segmentsWithMillion.length,
                'outerRadius'   : 212,
                'textFontSize'  : 22,
                'textFillStyle' : '#ffffff',
                'segments'      : segmentsWithMillion,
                'animation'     : {
                    'type'     : 'spinToStop', 'duration' : 8, 'spins' : 10,
                    'callbackFinished' : handleSpinFinish, 'easing'   : 'Power4.easeOut'
                },
                'pins'          : {
                    'number'    : segmentsWithMillion.length * 2,
                    'fillStyle' : 'silver',
                    'outerRadius': 4,
                    'margin': 5
                }
            });
        } catch (e) {
            console.error("Error initializing Winwheel:", e);
            if (ui.spinWheel.card) ui.spinWheel.card.innerHTML = '<p class="text-danger p-3">Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸.</p>';
        }
    }

    async function handleSpinStart() {
        if (wheelSpinning || !theWheel) return;
        if (allUsersCache.length === 0) {
            Swal.fire('Ø§Ù†ØªØ¸Ø±!', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙˆØ§Ø­Ù Ù„Ù„ØªØ¨Ø±Ø¹ Ù„Ù‡Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.', 'info');
            return;
        }

        ui.spinWheel.btn.disabled = true;
        ui.spinWheel.btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†...`;

        try {
            const res = await fetch('/api/spin_wheel', { method: 'POST' });
            const data = await res.json();

            if (!res.ok || !data.success) {
                throw new Error(data.message || `Server error: ${res.status}`);
            }

            const prizeWon = data.prize;
            let stopAtSegmentIndex = -1;

            for (let i = 1; i <= theWheel.numSegments; i++) {
                if (theWheel.segments[i]) {
                    let segmentText = theWheel.segments[i].text.replace(/,/g, '');
                    let segmentValue = (segmentText === 'Ù…Ù„ÙŠÙˆÙ†!') ? 1000000 : parseInt(segmentText);
                    if (segmentValue === prizeWon) {
                        stopAtSegmentIndex = i;
                        break;
                    }
                }
            }

            if (stopAtSegmentIndex === -1) {
                console.warn(`Prize ${prizeWon} not found, selecting random segment.`);
                stopAtSegmentIndex = Math.floor(Math.random() * theWheel.numSegments) + 1;
            }

            theWheel.animation.stopAngle = theWheel.getRandomForSegment(stopAtSegmentIndex);

            wheelSpinning = true;
            theWheel.startAnimation();
            ui.spinWheel.modal.classList.add('show');
            if (ui.spinWheel.modalCloseBtn) ui.spinWheel.modalCloseBtn.style.display = 'none';

            setSpinCooldown();

        } catch (error) {
            console.error("Spin Start Error:", error);
            Swal.fire('Ø®Ø·Ø£', error.message || 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….', 'error');
            resetSpinButton();
        }
    }

    function handleSpinFinish(indicatedSegment) {
        wheelSpinning = false;
        if (ui.spinWheel.modalCloseBtn) ui.spinWheel.modalCloseBtn.style.display = 'block';

        if (!indicatedSegment || typeof indicatedSegment.text === 'undefined') {
            console.error("Indicated segment is invalid:", indicatedSegment);
            Swal.fire('Ø¹Ø°Ø±Ø§Ù‹', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©. Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø£ÙŠ Ù†Ù‚Ø§Ø·.', 'error');
            resetSpinButton();
            checkSpinCooldown();
            return;
        }

        const prizeText = indicatedSegment.text.replace(/,/g, '');
        const prizeWon = (prizeText === 'Ù…Ù„ÙŠÙˆÙ†!') ? 1000000 : parseInt(prizeText);

        Swal.fire({
            title: `ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ ÙØ²Øª Ø¨Ù€ ${formatNumber(prizeWon)} Ù†Ù‚Ø·Ø©! ğŸ‰`,
            html: `<div>Ø§Ø®ØªØ± Ø§Ù„Ø²Ø§Ø­Ù Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ¨Ø±Ø¹ Ù„Ù‡ Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·:</div>
                   <select id="swal-donate-select" class="swal2-select mt-3" style="min-width: 200px;"></select>`,
            confirmButtonText: 'ØªØ¨Ø±Ø¹ Ø§Ù„Ø¢Ù†!',
            showCancelButton: true,
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡ (Ø¹Ø¯Ù… Ø§Ù„ØªØ¨Ø±Ø¹)',
            didOpen: () => {
                const select = document.getElementById('swal-donate-select');
                if (allUsersCache.length > 0) {
                    allUsersCache.forEach(user => select.add(new Option(user.name, user.name)));
                    select.selectedIndex = 0;
                } else {
                    select.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙˆØ§Ø­Ù Ù„Ù„ØªØ¨Ø±Ø¹!</option>';
                    Swal.getConfirmButton().disabled = true;
                }
            },
            preConfirm: () => {
                const selectedUser = document.getElementById('swal-donate-select').value;
                if (!selectedUser && allUsersCache.length > 0) {
                    Swal.showValidationMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø²Ø§Ø­Ù Ù„Ù„ØªØ¨Ø±Ø¹ Ù„Ù‡.');
                    return false;
                }
                return selectedUser;
            },
            allowOutsideClick: false
        }).then(async (result) => {
            if (result.isConfirmed && result.value) {
                const usernameToDonate = result.value;
                try {
                    const res = await fetch('/api/donate_points', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: new URLSearchParams({ username: usernameToDonate, points: prizeWon, visitor_name: visitorName })
                    });
                    const data = await res.json();
                    Swal.fire(data.success ? 'Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ!' : 'Ø®Ø·Ø£!', data.message, data.success ? 'success' : 'error');
                } catch(e){
                    Swal.fire('Ø®Ø·Ø£!', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø±Ø¹.', 'error');
                }
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                Swal.fire('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·.', 'info');
            }
            resetSpinButton();
            checkSpinCooldown();
        });
    }

    function checkSpinCooldown() {
        if (!ui.spinWheel.btn || !ui.spinWheel.timerContainer || !ui.spinWheel.timer) return;
        if(cooldownInterval) clearInterval(cooldownInterval);

        const lastSpin = localStorage.getItem('lastSpinTime');
        if (!lastSpin) {
            ui.spinWheel.btn.style.display = 'block';
            ui.spinWheel.btn.disabled = false;
            ui.spinWheel.timerContainer.style.display = 'none';
            return;
        }

        const twentyFourHours = 24 * 60 * 60 * 1000;
        const timePassed = Date.now() - parseInt(lastSpin);

        if (timePassed >= twentyFourHours) {
            localStorage.removeItem('lastSpinTime');
            ui.spinWheel.btn.style.display = 'block';
            ui.spinWheel.btn.disabled = false;
            ui.spinWheel.timerContainer.style.display = 'none';
        } else {
            ui.spinWheel.btn.style.display = 'none';
            ui.spinWheel.timerContainer.style.display = 'block';
            let timeLeft = twentyFourHours - timePassed;

            const updateTimer = () => {
                timeLeft -= 1000;
                if (timeLeft <= 0) {
                    clearInterval(cooldownInterval);
                    checkSpinCooldown();
                    return;
                }
                const h = Math.floor(timeLeft / (1000 * 60 * 60)).toString().padStart(2, '0');
                const m = Math.floor((timeLeft / (1000 * 60)) % 60).toString().padStart(2, '0');
                const s = Math.floor((timeLeft / 1000) % 60).toString().padStart(2, '0');
                if(ui.spinWheel.timer) ui.spinWheel.timer.textContent = `${h}:${m}:${s}`;
            };
            updateTimer();
            cooldownInterval = setInterval(updateTimer, 1000);
        }
    }

    function setSpinCooldown() {
        localStorage.setItem('lastSpinTime', Date.now().toString());
    }

    function resetSpinButton() {
        if (ui.spinWheel.btn) {
            ui.spinWheel.btn.disabled = false;
            ui.spinWheel.btn.innerHTML = `<i class="bi bi-arrow-repeat me-2"></i>Ù„Ù Ø§Ù„Ø¹Ø¬Ù„Ø© Ø§Ù„Ø¢Ù†!`;
        }
    }

    function setupEventListeners() {
        if (ui.searchInput) ui.searchInput.addEventListener('input', renderUserTable);

        if (ui.spinWheel.btn) ui.spinWheel.btn.addEventListener('click', handleSpinStart);
        if (ui.spinWheel.modalCloseBtn) {
            ui.spinWheel.modalCloseBtn.addEventListener('click', () => {
                if (!wheelSpinning) ui.spinWheel.modal.classList.remove('show');
            });
        }

        document.querySelectorAll('.custom-modal .custom-close-btn:not(#spinWheelModal .custom-close-btn)').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.custom-modal');
                if (modal) modal.classList.remove('show');
            });
        });
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('custom-modal')) {
                if (e.target.id === 'spinWheelModal' && wheelSpinning) return;
                e.target.classList.remove('show');
            }
        });


        if (ui.tableBody) {
            ui.tableBody.addEventListener('click', e => {
                const likeBtn = e.target.closest('.like-btn');
                const chartBtn = e.target.closest('.chart-btn');
                if (likeBtn) {
                    const username = likeBtn.dataset.username;
                    const likedUsers = new Set(JSON.parse(localStorage.getItem('likedUsers')) || []);
                    const action = likedUsers.has(username) ? 'unlike' : 'like';
                    const countSpan = likeBtn.querySelector('.like-count');
                    let currentCount = parseInt((countSpan.textContent || '0').replace(/,/g, ''));

                    if(action === 'like') {
                        likedUsers.add(username); likeBtn.classList.add('liked'); likeBtn.classList.remove('btn-outline-danger');
                        countSpan.textContent = formatNumber(currentCount + 1);
                    } else {
                        likedUsers.delete(username); likeBtn.classList.remove('liked'); likeBtn.classList.add('btn-outline-danger');
                        countSpan.textContent = formatNumber(Math.max(0, currentCount - 1));
                    }
                    localStorage.setItem('likedUsers', JSON.stringify([...likedUsers]));
                    fetch(`/like/${username}?action=${action}`, { method:'POST', body: new URLSearchParams({visitor_name: visitorName}) });
                }
                if(chartBtn && ui.userChartModal) {
                    showUserHistoryChart(chartBtn.dataset.username);
                }
            });
        }

        if(ui.checkCrawlBtn) ui.checkCrawlBtn.addEventListener('click', handleCrawlCheck);
        if(ui.startDuelBtn) ui.startDuelBtn.addEventListener('click', handleDuelStart);

        if (ui.nominateBtn) {
            ui.nominateBtn.addEventListener('click', () => {
                Swal.fire({
                    title: 'Ø±Ø´Ø­ Ù†ÙØ³Ùƒ ÙƒØ²Ø§Ø­Ù', input: 'text', inputLabel: 'Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù„Ù„ØªØ±Ø´ÙŠØ­',
                    inputPlaceholder: 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ±Ø´ÙŠØ­Ù‡...', showCancelButton: true,
                    confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ±Ø´ÙŠØ­', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                    inputValidator: (v) => !v && 'ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù…!'
                }).then(async res => {
                    if (res.isConfirmed && res.value) {
                        try {
                            const r = await fetch('/api/nominate', {
                                method: 'POST', body: new URLSearchParams({name: res.value, visitor_name: visitorName})
                            });
                            const j = await r.json();
                            if(r.ok && j.success) Swal.fire('ØªÙ…!', j.message, 'success');
                            else Swal.fire('Ø®Ø·Ø£!', j.message || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ±Ø´ÙŠØ­.', 'error');
                        } catch(e){ Swal.fire('Ø®Ø·Ø£!', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….', 'error');}
                    }
                })
            });
        }
        if (ui.reportBtn) {
            ui.reportBtn.addEventListener('click', () => {
                if (!allUsersCache.length) return Swal.fire('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙˆØ§Ø­Ù Ù„Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù†Ù‡Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.', '', 'info');
                const userOptions = allUsersCache.reduce((obj, user) => { obj[user.name] = user.name; return obj; }, {});
                Swal.fire({
                    title: 'Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø²Ø§Ø­Ù',
                    html: `<label for="swal-reported-user" class="swal2-label" style="display: block; margin-bottom: .5em;">Ø§Ø®ØªØ± Ø§Ù„Ø²Ø§Ø­Ù:</label>
                           <select id="swal-reported-user" class="swal2-select" style="min-width: 200px; margin-bottom: 1em;"></select>
                           <label for="swal-report-reason" class="swal2-label" style="display: block; margin-bottom: .5em;">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº:</label>
                           <textarea id="swal-report-reason" class="swal2-textarea" placeholder="Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø£Ùˆ Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº..."></textarea>`,
                    showCancelButton: true, confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                    didOpen: () => {
                        const select = document.getElementById('swal-reported-user');
                        Object.keys(userOptions).forEach(key => select.add(new Option(userOptions[key], key)));
                         if(select.options.length > 0) select.selectedIndex = 0;
                    },
                    preConfirm: () => {
                        const user = document.getElementById('swal-reported-user').value;
                        const reason = document.getElementById('swal-report-reason').value;
                        if (!user) { Swal.showValidationMessage('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø²Ø§Ø­Ù Ù„Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù†Ù‡!'); return false; }
                        if (!reason) { Swal.showValidationMessage('ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø¨Ù„Ø§Øº!'); return false;}
                        return { user, reason };
                    }
                }).then(async (result) => {
                    if (result.isConfirmed && result.value) {
                        try {
                            const r = await fetch('/api/report', {
                                method: 'POST',
                                body: new URLSearchParams({ reported_user: result.value.user, reason: result.value.reason, visitor_name: visitorName })
                            });
                            const j = await r.json();
                            if(r.ok && j.success) Swal.fire('ØªÙ…!', j.message, 'success');
                            else Swal.fire('Ø®Ø·Ø£!', j.message || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº.', 'error');
                        } catch(e){ Swal.fire('Ø®Ø·Ø£!', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….', 'error');}
                    }
                });
            });
        }
    }

    function handleCrawlCheck() {
        if(!ui.crawlNameInput || !ui.crawlModalTitle || !ui.crawlChartCanvas || !ui.crawlModal) return;
        const name = ui.crawlNameInput.value.trim();
        if (!name) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„ÙØ­Øµ Ø§Ù„Ù†Ø³Ø¨Ø©.', 'warning');

        const existingUser = allUsersCache.find(u => u.name.toLowerCase() === name.toLowerCase());
        let percentage, title, text, color;
        if (existingUser) {
            const maxPoints = Math.max(...allUsersCache.map(u => u.points || 0), 1);
            percentage = Math.min(Math.round(((existingUser.points || 0) / maxPoints) * 100), 100);
            title = `Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø²Ø§Ø­Ù Ø§Ù„Ø£ØµÙ„ÙŠ: ${existingUser.name}`; text = ` Ø²Ø§Ø­Ù Ù…Ø¹ØªÙ…Ø¯ Ø¨Ù†Ø³Ø¨Ø©ğŸ¦ ${percentage}%. ÙˆÙ„Ø¯Ù Ø²Ø§Ø­ÙØ§Ù‹ Ùˆ  Ø³ÙŠØ¨Ù‚Ù‰ Ø²Ø§Ø­Ù  Ù…Ø­ØªÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙˆØ­Ø©!`; color = '#8e44ad';
        } else {
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
                hash = hash & hash;
            }
            percentage = (Math.abs(hash) % 100) + 1;

            title = `Ù†ØªÙŠØ¬Ø© ÙØ­Øµ Ø§Ù„Ø²Ø­Ù Ù„Ù€Ù "${name}"`;
            if (percentage < 30) { text = `Ù†Ø³Ø¨Ø© Ø²Ø­ÙÙƒ ${percentage}%. Ø²Ø§Ø­Ù Ù…Ø¨ØªØ¯Ø¦ØŒ Ø£Ù…Ø§Ù…Ùƒ Ø·Ø±ÙŠÙ‚ Ù„Ù„ØªÙˆØ¨Ø© !`; color = '#2ecc71'; }
            else if (percentage < 50) { text = `Ù†Ø³Ø¨Ø© Ø²Ø­ÙÙƒ ${percentage}%. Ø²Ø§Ø­Ù Ø§Ù„Ø§ÙŠØ²ÙŠ ØŒ ÙƒÙ„Ù†Ø§ Ø¹Ø§Ø±ÙÙŠÙ† Ù‚ØµØµÙƒ Ù„Ø§ ØªØ­Ø§ÙˆÙ„ ØªØªØºÙŠØ±!`; color = '#f1c40f'; }
            else if (percentage < 70) { text = `Ù†Ø³Ø¨Ø© Ø²Ø­ÙÙƒ ${percentage}%. Ø²Ø§Ø­Ù Ø®Ø±Ø§Ø¦ÙŠ ØŒ Ø¨Ø¯ÙŠØª ØªØºÙˆØµ ÙˆÙ„Ø§ Ø¹ÙˆØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„ÙŠÙˆÙ…!`; color = '#f1c40f'; }
            else { text = `Ù†Ø³Ø¨Ø© Ø²Ø­ÙÙƒ ${percentage}%. Ø®Ø·Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹! Ø§Ù„Ù„Ù‡ ÙŠØ¹ÙˆØ¶ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø´ÙˆØ§Ù„ Ø±Ø²!`; color = '#e74c3c'; }
        }
        ui.crawlModalTitle.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ..."; ui.crawlModalText.textContent = "";
        if (crawlChartInstance) { crawlChartInstance.destroy(); }
        ui.crawlModal.classList.add('show');

        const ctx = ui.crawlChartCanvas.getContext('2d');
        setTimeout(() => {
            ui.crawlModalTitle.textContent = title; ui.crawlModalText.textContent = text; ui.crawlModalText.style.color = color;
            crawlChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ù†Ø³Ø¨Ø© Ø§Ù„Ø²Ø­Ù', 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø±Ø§Ø¡Ø©'],
                    datasets: [{
                        data: [percentage, 100 - percentage],
                        backgroundColor: [color, 'rgba(255, 255, 255, 0.1)'],
                        borderColor: 'var(--card-bg)',
                        borderWidth: 4
                    }]
                },
                options: {
                    animation: { animateRotate: true, duration: 2000 },
                    responsive: true, maintainAspectRatio: false, cutout: '70%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        }, 1500);
    }

    async function showUserHistoryChart(username) {
        if(!ui.userChartModal || !ui.chartModalLabel || !ui.userPointsChartCanvas) return;
        try {
            const response = await fetch(`/api/user_history/${username}`);
            if(!response.ok) throw new Error("Failed to fetch history");
            let history = await response.json();

            if(!history || !history.length) {
                return Swal.fire({icon: 'info', title: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', text: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù†Ù‚Ø§Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„Ø²Ø§Ø­Ù Ø¨Ø¹Ø¯.'});
            }
            if (history.length === 1) {
                 const firstPoint = history[0];
                 history.unshift({ points: firstPoint.points, timestamp: firstPoint.timestamp - (24 * 60 * 60) });
            }

            ui.chartModalLabel.innerText = `ØªÙ‚Ø¯Ù… Ø§Ù„Ø²Ø§Ø­Ù: ${username}`;
            if (userChartInstance) userChartInstance.destroy();

            const chartContext = ui.userPointsChartCanvas.getContext('2d');
            const gradient = chartContext.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0, 242, 255, 0.4)');
            gradient.addColorStop(1, 'rgba(159, 122, 234, 0.1)');

            userChartInstance = new Chart(chartContext, {
                type: 'line',
                data: {
                    labels: history.map(h => new Date(h.timestamp * 1000).toLocaleDateString('ar-EG', { day: '2-digit', month: 'short', hour:'2-digit', minute:'2-digit'})),
                    datasets: [{
                        label: 'Ø§Ù„Ù†Ù‚Ø§Ø·', data: history.map(h => h.points),
                        fill: true, backgroundColor: gradient, borderColor: '#00f2ff',
                        borderWidth: 3, pointBackgroundColor: '#fff', pointBorderColor: '#00f2ff',
                        pointRadius: 5, pointHoverRadius: 8, tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: 'var(--text-color)', font: { family: "Almarai" } }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { ticks: { color: 'var(--text-color)', font: { family: "Almarai" } }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false }, tooltip: { titleFont: { family: "Almarai" }, bodyFont: { family: "Almarai" } } }
                }
            });
            ui.userChartModal.classList.add('show');
        } catch(e) {
            console.error("User History Chart Error:", e);
            Swal.fire('Ø®Ø·Ø£', 'Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ Ø£Ùˆ Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ù†Ù‚Ø§Ø· Ù‡Ø°Ø§ Ø§Ù„Ø²Ø§Ø­Ù.', 'error');
        }
    }

    function handleDuelStart() {
        if (!ui.duelUser1Select || !ui.duelUser2Select || !ui.fighter1Name || !ui.fighter2Name || !ui.fighter1Health || !ui.fighter2Health || !ui.duelResultText || !ui.fighter1Div || !ui.fighter2Div || !ui.duelModal) return;

        const name1 = ui.duelUser1Select.value;
        const name2 = ui.duelUser2Select.value;

        if (!name1 || !name2) return Swal.fire('Ø®Ø·Ø£!', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø²ÙˆØ§Ø­Ù ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹.', 'error');
        if (name1 === name2) return Swal.fire('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù…ÙˆØ§Ø¬Ù‡Ø© Ù†ÙØ³ Ø§Ù„Ø²Ø§Ø­Ù!', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø²Ø§Ø­ÙÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†.', 'warning');

        ui.fighter1Name.textContent = name1;
        ui.fighter2Name.textContent = name2;
        ui.fighter1Health.style.width = '100%';
        ui.fighter2Health.style.width = '100%';
        ui.duelResultText.textContent = '';
        ui.fighter1Div.classList.remove('fighting');
        ui.fighter2Div.classList.remove('fighting');
        ui.duelModal.classList.add('show');

        const winner = Math.random() < 0.5 ? 1 : 2;

        setTimeout(() => {
            ui.fighter1Div.classList.add('fighting');
            ui.fighter2Div.classList.add('fighting');
            ui.duelResultText.textContent = 'Ø§Ù„Ø²Ø­ÙÙ†Ø© ØªØ¨Ø¯Ø£...!';
            if (winner === 1) {
                ui.fighter2Health.style.width = '0%';
            } else {
                ui.fighter1Health.style.width = '0%';
            }
        }, 500);

        setTimeout(() => {
            ui.fighter1Div.classList.remove('fighting');
            ui.fighter2Div.classList.remove('fighting');
            const winnerName = winner === 1 ? name1 : name2;
            ui.duelResultText.innerHTML = `ğŸ† Ø§Ù„Ø²Ø§Ø­Ù Ø§Ù„Ø§ÙƒØ¨Ø± Ù‡Ùˆ: <strong>${winnerName}</strong> ğŸ†`;
        }, 2500);
    }

    initializeApp();
});
</script>
{% endblock %}
