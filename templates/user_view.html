{% extends "base.html" %} {% block title %}Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‚Ø§Ø·{% endblock %} {% block
header_title %}Ù‚Ø§Ø¦Ù…Ø© Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø®Ø§Øµ (ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø±){% endblock %} {% block content %}
<div class="row g-4">
  <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø¬Ø¯ÙˆÙ„ -->
  <div class="col-lg-8">
    <div class="card shadow-lg h-100">
      <div
        class="card-header d-flex flex-wrap align-items-center justify-content-between"
      >
        <div class="d-flex align-items-center">
          <i class="bi bi-bar-chart-line-fill me-2 fs-5"></i>
          <span class="fs-5">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù… Ù„ÙƒÙ„ Ø±Ø®ÙŠØµ</span>
        </div>
        <div class="mt-2 mt-md-0">
          <input
            type="search"
            id="searchInput"
            class="form-control form-control-sm"
            placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø±Ø®ÙŠØµ..."
          />
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th scope="col" style="width: 10%">Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                <th scope="col">Ø§Ø³Ù… Ø§Ù„Ø±Ø®ÙŠØµ</th>
                <th scope="col" class="text-center">Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                <th scope="col" class="text-center" style="width: 20%">
                  Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª
                </th>
              </tr>
            </thead>
            <tbody id="user-table-body">
              <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ -->
              <tr>
                <td colspan="4" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2 mb-0">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù‚Ø§Ø¹Ø© Ø§Ù„Ù…Ø´Ø§Ù‡ÙŠØ± -->
  <div class="col-lg-4">
    <div class="card shadow-lg">
      <div class="card-header bg-warning text-dark d-flex align-items-center">
        <i class="bi bi-trophy-fill me-2 fs-5"></i>
        <span class="fs-5">ØªÙˆØ¨ 3 Ù„Ø­ÙŠØ³Ø©</span>
      </div>
      <ul class="list-group list-group-flush" id="hall-of-fame">
        <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ -->
        <li class="list-group-item text-center p-3">
          <div
            class="spinner-border spinner-border-sm text-secondary"
            role="status"
          ></div>
        </li>
      </ul>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<!-- Firebase JavaScript SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      try {
          const firebaseConfig = {{ firebase_config|tojson }};
          if (!firebaseConfig.apiKey) throw new Error("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©.");
          firebase.initializeApp(firebaseConfig);
      } catch (e) {
          console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:", e);
          displayError("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.");
          return;
      }

      const database = firebase.database();
      const usersRef = database.ref('users');
      const leaderRef = database.ref('leader_info');
      let likedUsers = JSON.parse(localStorage.getItem('likedUsers')) || {};
      let allUsersCache = [];
      let leaderInfoCache = {};

      const userTableBody = document.getElementById('user-table-body');
      const hallOfFameList = document.getElementById('hall-of-fame');
      const searchInput = document.getElementById('searchInput');

      function formatNumber(num) {
          return new Intl.NumberFormat('en-US').format(num || 0);
      }

      function displayError(message) {
          userTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-5"><strong>${message}</strong></td></tr>`;
      }

      window.handleLike = async function(button, username) {
          const isCurrentlyLiked = likedUsers[username];
          const action = isCurrentlyLiked ? 'unlike' : 'like';
          button.disabled = true;
          try {
              const formData = new FormData();
              formData.append('action', action);
              const response = await fetch(`/like/${username}`, { method: 'POST', body: formData });
              if (!response.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…');
              if (isCurrentlyLiked) { delete likedUsers[username]; }
              else { likedUsers[username] = true; }
              localStorage.setItem('likedUsers', JSON.stringify(likedUsers));
          } catch (error) {
              console.error("Failed to update like:", error);
              button.disabled = false;
          }
      }

      function renderUI() {
          const searchTerm = searchInput.value.toLowerCase();
          const filteredUsers = allUsersCache.filter(user => user.name.toLowerCase().includes(searchTerm));
          renderMainTable(filteredUsers);
          renderHallOfFame(allUsersCache);
      }

      function renderMainTable(usersToRender) {
          userTableBody.innerHTML = '';
          if (usersToRender.length > 0) {
              usersToRender.forEach(user => {
                  const originalIndex = allUsersCache.findIndex(u => u.name === user.name) + 1;
                  const row = document.createElement('tr');
                  let leaderBadge = '';
                  if (originalIndex === 1 && user.name === leaderInfoCache.name) {
                      const timeSinceLeader = (Date.now() / 1000) - leaderInfoCache.timestamp;
                      if (timeSinceLeader < 600) {
                          leaderBadge = '<span class="badge bg-danger ms-2">Ù…ØªØµØ¯Ø± Ø¬Ø¯ÙŠØ¯!</span>';
                      }
                  }
                  const isLiked = likedUsers[user.name];
                  const likeButton = `<button class="btn btn-sm like-btn ${isLiked ? 'btn-primary liked' : 'btn-outline-primary'}" onclick="handleLike(this, '${user.name}')" title="${isLiked ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨' : 'Ø¥Ø¹Ø¬Ø§Ø¨'}"><span class="fw-bold">() ğŸ‘ </span><span class="badge bg-light text-dark ms-1">${formatNumber(user.likes)}</span></button>`;
                  row.innerHTML = `<th scope="row" class="fs-5 align-middle">#${originalIndex}</th><td class="align-middle">${user.name || ''} ${leaderBadge}</td><td class="fs-5 fw-bold text-center align-middle">${formatNumber(user.points)}</td><td class="text-center align-middle">${likeButton}</td>`;
                  userTableBody.appendChild(row);
              });
          } else {
              userTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">${searchInput.value ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ·Ø§Ø¨Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø­Ø«.' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.'}</td></tr>`;
          }
      }

      function renderHallOfFame(allUsers) {
          hallOfFameList.innerHTML = '';
          const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
          const topUsers = allUsers.slice(0, 3);
          if (topUsers.length > 0) {
              topUsers.forEach((user, index) => {
                  const listItem = document.createElement('li');
                  listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                  listItem.innerHTML = `<span>${medals[index] || 'â­'} ${user.name}</span><span class="badge bg-primary rounded-pill">${formatNumber(user.points)}</span>`;
                  hallOfFameList.appendChild(listItem);
              });
          } else {
              hallOfFameList.innerHTML = '<li class="list-group-item text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¨Ø·Ø§Ù„ Ø¨Ø¹Ø¯.</li>';
          }
      }

      function setupListeners() {
          searchInput.addEventListener('input', renderUI);

          usersRef.on('value', (userSnapshot) => {
              const usersData = userSnapshot.val();

              leaderRef.once('value').then(leaderSnapshot => {
                  leaderInfoCache = leaderSnapshot.val() || {};

                  if (usersData && typeof usersData === 'object') {
                      // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ØªÙŠ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØªØ§Ø­ ÙƒØ§Ø³Ù…
                      allUsersCache = Object.keys(usersData).map(key => {
                          const userData = usersData[key];
                          // Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡ÙŠ ÙƒØ§Ø¦Ù†
                          if (userData && typeof userData === 'object') {
                              return {
                                  name: key, // <-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‡Ù…
                                  points: userData.points || 0,
                                  likes: userData.likes || 0
                              };
                          }
                          return null;
                      }).filter(Boolean).sort((a, b) => (b.points || 0) - (a.points || 0));
                  } else {
                      allUsersCache = [];
                  }
                  renderUI();
              });
          }, (error) => {
              console.error("Firebase read failed:", error);
              displayError("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.");
          });
      }

      setupListeners();
  });
</script>
{% endblock %}
