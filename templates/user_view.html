{% extends "base.html" %}
{% block title %}Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‚Ø§Ø·{% endblock %}
{% block header_title %}Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²ÙˆØ§Ø­Ù Ø§Ù„Ø±Ø³Ù…ÙŠØ© (ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø±){% endblock %}

{% block styles %}
<style>
    .chart-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(10, 10, 20, 0.85);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1055;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease;
    }

        .chart-overlay.show {
            opacity: 1;
            visibility: visible;
        }

    .chart-container {
        position: relative;
        width: 90%;
        max-width: 900px;
        padding: 1.5rem 2rem;
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }

    .chart-overlay.show .chart-container {
        transform: scale(1);
    }

    .chart-close-btn {
        position: absolute;
        top: 10px;
        left: 20px;
        font-size: 2.5rem;
        color: rgba(255, 255, 255, 0.7);
        background: none;
        border: none;
        cursor: pointer;
        z-index: 1060;
        line-height: 1;
    }

        .chart-close-btn:hover {
            color: #fff;
        }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-8">
        <div class="card shadow-lg h-100">
            <div class="card-header d-flex justify-content-between align-items-center"><span><i class="bi bi-bar-chart-line-fill me-2"></i>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø²ÙˆØ§Ø­Ù</span><input type="search" id="searchInput" class="form-control form-control-sm w-50" placeholder="ğŸ” Ø§Ø¨Ø­Ø«..." /></div>
            <div class="card-body table-responsive">
                <table class="table table-hover align-middle">
                    <thead><tr><th>#</th><th> Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø­Ù  </th><th class="text-center">Ø§Ù„Ù†Ù‚Ø§Ø·</th><th class="text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                    <tbody id="user-table-body"></tbody>
                </table>
                <div id="loading-spinner" class="text-center py-5"><div class="spinner-border text-danger"></div><p class="mt-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø²Ø­Ù...</p></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="vstack gap-4">
            <div class="card shadow-lg"><div class="card-header bg-warning text-dark"><i class="bi bi-trophy-fill me-2"></i>ØªÙˆØ¨ 3 Ø¨Ø§Ù„Ø²Ø­Ù</div><ul class="list-group list-group-flush" id="hall-of-fame"></ul></div>
            <div class="card shadow-lg"><div class="card-header" style="background: var(--primary-glow); color: #fff;"><i class="bi bi-award-fill me-2"></i> Ø§Ù„Ø²Ø§Ø­Ù Ø§Ù„Ø§ÙƒØ«Ø± Ø°ÙƒØ±Ø§Ù‹</div><ul class="list-group list-group-flush" id="honor-roll-view-list"></ul></div>
            <div class="card shadow-lg"><div class="card-header"><i class="bi bi-person-check-fill me-2 text-success"></i>Ù…Ø±Ø´Ø­ÙˆÙ† Ù„Ù„Ø¯Ø®ÙˆÙ„</div><ul class="list-group list-group-flush" id="candidates-list"></ul></div>
            <div class="card shadow-lg"><div class="card-header"><i class="bi bi-joystick me-2"></i>ØªÙØ§Ø¹Ù„ Ù…Ø¹Ù†Ø§</div><div class="card-body d-grid gap-2"><button class="btn btn-success" id="nominate-btn"><i class="bi bi-person-up me-2"></i>Ø±Ø´Ø­ Ù†ÙØ³Ùƒ</button><button class="btn btn-outline-danger" id="report-btn"><i class="bi bi-exclamation-triangle-fill me-2"></i>Ø£Ø¨Ù„Øº Ø¹Ù† Ø²Ø§Ø­Ù</button></div></div>
        </div>
    </div>
</div>
<div class="chart-overlay" id="customChartOverlay">
    <button class="chart-close-btn" id="customChartCloseBtn">Ã—</button>
    <div class="chart-container card">
        <h5 class="mb-3" id="chartModalLabel"></h5>
        <div style="height: 400px;"><canvas id="userPointsChart"></canvas></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ui = {
        tableBody: document.getElementById('user-table-body'), hallOfFame: document.getElementById('hall-of-fame'),
        candidatesList: document.getElementById('candidates-list'), honorRollList: document.getElementById('honor-roll-view-list'),
        searchInput: document.getElementById('searchInput'), loadingSpinner: document.getElementById('loading-spinner'),
        nominateBtn: document.getElementById('nominate-btn'), reportBtn: document.getElementById('report-btn'),
        chartOverlay: document.getElementById('customChartOverlay'), chartCloseBtn: document.getElementById('customChartCloseBtn')
    };
    let allUsersCache = [], honorRollCache = [], candidatesCache = [], likedUsers = new Set(), chartInstance = null, visitorName = '';
    const formatNumber = (num) => new Intl.NumberFormat('ar-EG').format(num || 0);
    const displayError = (msg) => { if (ui.loadingSpinner) ui.loadingSpinner.innerHTML = `<p class="text-danger py-4">${msg}</p>`; };
    const loadLikedUsers = () => { try { likedUsers = new Set(JSON.parse(localStorage.getItem('likedUsers')) || []); } catch { likedUsers = new Set(); }};
    const showUserChart = async (username) => {
        try {
            const response = await fetch(`/api/user_history/${username}`);
            if(!response.ok) throw new Error("Failed to fetch history");
            const history = await response.json();
            if(!history.length) return Swal.fire({icon: 'info', title: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', text: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù†Ù‚Ø§Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„Ø²Ø§Ø­Ù Ø¨Ø¹Ø¯.'});
            document.getElementById('chartModalLabel').innerText = `ØªÙ‚Ø¯Ù… Ø§Ù„Ø²Ø§Ø­Ù: ${username}`;
            if (chartInstance) chartInstance.destroy();
            const chartContext = document.getElementById('userPointsChart').getContext('2d');
            const gradient = chartContext.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0, 242, 255, 0.4)'); gradient.addColorStop(1, 'rgba(159, 122, 234, 0.1)');
            chartInstance = new Chart(chartContext, {
                type: 'line', data: { labels: history.map(h => new Date(h.timestamp * 1000).toLocaleDateString('ar-EG', { day: '2-digit', month: 'short' })), datasets: [{ label: 'Ø§Ù„Ù†Ù‚Ø§Ø·', data: history.map(h => h.points), fill: true, backgroundColor: gradient, borderColor: '#00f2ff', borderWidth: 3, pointBackgroundColor: '#fff', pointBorderColor: '#00f2ff', pointRadius: 5, pointHoverRadius: 8, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: 'var(--text-color)', font: { family: "Almarai" } }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: 'var(--text-color)', font: { family: "Almarai" } }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { titleFont: { family: "Almarai" }, bodyFont: { family: "Almarai" } } } }
            });
            ui.chartOverlay.classList.add('show');
        } catch(e) { console.error("Chart Error:", e); Swal.fire('Ø®Ø·Ø£', ' Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ Ø£Ùˆ Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ù„Ù„Ø²ÙˆØ§Ø­Ù.', 'error'); }
    };
    const renderUI = () => {
        loadLikedUsers();
        const term = ui.searchInput.value.toLowerCase();
        const filtered = allUsersCache.filter(u => u.name.toLowerCase().includes(term));
        ui.tableBody.innerHTML = '';
        if (filtered.length) {
            ui.loadingSpinner.style.display = 'none';
            filtered.forEach(user => {
                const rank = allUsersCache.findIndex(u => u.name === user.name) + 1;
                const honorBadge = honorRollCache.includes(user.name) ? `<span class="badge rounded-pill ms-2" style="background:var(--primary-glow);color:#fff;"><i class="bi bi-award-fill"></i></span>` : '';
                const row = document.createElement('tr');
                row.innerHTML = `<th class="align-middle">#${rank}</th><td class="align-middle fw-bold">${user.name}${honorBadge}</td><td class="text-center align-middle fs-5 fw-bold">${formatNumber(user.points)}</td>`;
                const actionTd = document.createElement('td'); actionTd.className = 'text-center align-middle';
                const likeBtn = document.createElement('button'); likeBtn.className = `btn btn-sm btn-outline-danger like-btn ${likedUsers.has(user.name) ? 'active' : ''}`; likeBtn.disabled = likedUsers.has(user.name); likeBtn.innerHTML = `<i class="bi bi-heart-fill"></i> ${formatNumber(user.likes)}`;
                likeBtn.onclick = () => { fetch(`/like/${user.name}`,{method:'POST', body: new URLSearchParams({visitor_name: visitorName})}).then(()=>{likedUsers.add(user.name);localStorage.setItem('likedUsers',JSON.stringify([...likedUsers]));likeBtn.disabled=true;})};
                const chartBtn = document.createElement('button'); chartBtn.className = 'btn btn-sm btn-outline-info ms-2'; chartBtn.title = 'Ø¹Ø±Ø¶ ØªÙ‚Ø¯Ù… Ø§Ù„Ø²Ø­Ø§Ù '; chartBtn.innerHTML = `<i class="bi bi-graph-up-arrow"></i>`;
                chartBtn.onclick = () => showUserChart(user.name);
                actionTd.appendChild(likeBtn); actionTd.appendChild(chartBtn); row.appendChild(actionTd); ui.tableBody.appendChild(row);
            });
        } else { ui.loadingSpinner.style.display = 'block'; ui.loadingSpinner.innerHTML = `<p class="text-muted py-4">${term ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø§Ø­Ù ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«.' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.'}</p>`; }
        ui.hallOfFame.innerHTML = ''; allUsersCache.slice(0, 3).forEach((u, i) => ui.hallOfFame.innerHTML += `<li class="list-group-item d-flex justify-content-between"><span>${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]} ${u.name}</span><span class="badge rounded-pill" style="background-color:var(--primary-glow)">${formatNumber(u.points)}</span></li>`);
        ui.candidatesList.innerHTML = ''; if(candidatesCache.length) candidatesCache.forEach(name => ui.candidatesList.innerHTML += `<li class="list-group-item"><i class="bi bi-person-check-fill me-2"></i>${name}</li>`); else ui.candidatesList.innerHTML = `<li class="list-group-item text-muted text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø´Ø­ÙˆÙ†.</li>`;
        ui.honorRollList.innerHTML = ''; if(honorRollCache.length) honorRollCache.forEach(name => ui.honorRollList.innerHTML += `<li class="list-group-item fw-bold text-center"><i class="bi bi-star-fill text-warning me-2"></i>${name}</li>`); else ui.honorRollList.innerHTML = `<li class="list-group-item text-muted text-center">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©.</li>`;
    };
    const initApp = async () => {
        visitorName = localStorage.getItem('visitorNickname');
        if (!visitorName) {
            const { value: name } = await Swal.fire({ title: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!', input: 'text', inputLabel: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ¹Ø§Ø± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©', inputPlaceholder: 'Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±...', allowOutsideClick: false, allowEscapeKey: false, inputValidator: (v) => !v && 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø­ØªÙ‰ Ù„Ùˆ Ø²Ø§Ø­Ù !' });
            if (name) { visitorName = name.trim(); localStorage.setItem('visitorNickname', visitorName); }
        }
        try {
            const banStatusRes = await fetch(`/api/check_ban_status/${visitorName}`);
            const banStatus = await banStatusRes.json();
            if(banStatus.is_banned) { document.body.innerHTML = `<div class="container text-center mt-5"><div class="card p-5"><h1 class="text-danger">Ù„Ù‚Ø¯ ØªÙ… Ø­Ø¸Ø±Ùƒ ÙŠØ§ Ø§Ø¨Ù† Ø§Ù„Ù‚Ø­Ø¨Ø© </h1><p class="fs-5"> Ø­Ø¸Ø±ØªÙƒ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù…  Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ§ Ø±Ø®ÙŠØµ.</p></div></div>`; return; }
            const config = JSON.parse('{{ firebase_config|tojson|safe }}');
            if (!config?.apiKey) throw new Error("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
            if (!firebase.apps.length) firebase.initializeApp(config);
            const db = firebase.database();
            const handleNomination = async () => { const { value: name } = await Swal.fire({ title: ' Ø±Ø´Ø­ Ù†ÙØ³Ùƒ ÙƒØ²Ø§Ø­Ù', input: 'text', inputLabel: 'Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ', showCancelButton: true, confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡', inputValidator: (v) => !v && 'ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù…!' }); if (name) { const r = await fetch('/api/nominate', { method: 'POST', body: new URLSearchParams({name, visitor_name: visitorName}) }); const j = await r.json(); if(j.action === 'ban'){ localStorage.setItem('isBanned','true'); Swal.fire({icon:'error',title:'ØªÙ… Ø§Ù„Ø­Ø¸Ø±!',text:j.message}).then(()=>window.location.reload()); } else { Swal.fire({ icon: j.success ? 'success' : 'error', title: j.message }); } } };
            const handleUserReport = () => { if (!allUsersCache.length) return Swal.fire('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙˆØ§Ø­Ù Ù„Ù„Ø¥Ø¨Ù„Ø§Øº.', '', 'info'); const opts = allUsersCache.reduce((a, u) => ({ ...a, [u.name]: u.name }), {}); Swal.fire({ title: 'Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø²Ø§Ø­Ù Ø§Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©', html: `<select id="swal-in1" class="swal2-select"></select><textarea id="swal-in2" class="swal2-textarea" placeholder="Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©..."></textarea>`, showCancelButton: true, confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„', didOpen: () => Object.keys(opts).forEach(k => document.getElementById('swal-in1').add(new Option(opts[k], k))), preConfirm: () => ({ user: document.getElementById('swal-in1').value, reason: document.getElementById('swal-in2').value }) }).then(async (res) => { if (res.isConfirmed && res.value.reason) { const r = await fetch('/api/report', { method: 'POST', body: new URLSearchParams({ reported_user: res.value.user, reason: res.value.reason, visitor_name: visitorName }) }); const j = await r.json(); if(j.action === 'ban'){ localStorage.setItem('isBanned','true'); Swal.fire({icon:'error',title:'ØªÙ… Ø§Ù„Ø­Ø¸Ø±!',text:j.message}).then(()=>window.location.reload()); } else { Swal.fire({ icon: j.success ? 'success' : 'error', title: j.message }); } } else if(res.isConfirmed && !res.value.reason) { Swal.showValidationMessage('ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø¨Ù„Ø§Øº!'); } }); };
            ui.nominateBtn.onclick = handleNomination;
            ui.reportBtn.onclick = handleUserReport;
            ui.searchInput.oninput = renderUI;
            ui.chartCloseBtn.onclick = () => ui.chartOverlay.classList.remove('show');
            ui.chartOverlay.onclick = (e) => { if(e.target === ui.chartOverlay) ui.chartOverlay.classList.remove('show'); };
            db.ref('users').on('value', s => { const data = s.val()||{}; allUsersCache = Object.keys(data).map(k=>({name:k, ...data[k]})).sort((a,b)=>b.points-a.points); renderUI(); });
            db.ref('site_settings/honor_roll').on('value', s => { honorRollCache = Object.values(s.val()||{}).map(i => i.name); renderUI(); });
            db.ref('candidates').on('value', s => { candidatesCache = Object.keys(s.val()||{}); renderUI(); });
        } catch (e) { console.error(e); displayError("ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„."); }
    };
    initApp();
});
</script>
{% endblock %}
