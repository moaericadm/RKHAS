<!-- START OF FILE user_view.html -->
{% extends "base.html" %}
{% block title %}ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÜŸÇÿßÿ∑{% endblock %}
{% block header_title %}ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≤Ÿàÿßÿ≠ŸÅ ÿßŸÑÿ±ÿ≥ŸÖŸäÿ© (ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ®ÿßÿ¥ÿ±){% endblock %}

{% block styles %}
<style>
    .table thead th {
        background-color: var(--primary-glow) !important;
        color: white !important;
        text-shadow: 0 0 5px rgba(0,0,0,0.5);
        border-color: var(--primary-glow) !important;
    }

    html:not(.dark-mode) .table thead th {
        background-color: var(--header-color) !important;
    }

    .like-btn.liked {
        background-color: #dc3545;
        color: white;
        border-color: #dc3545;
    }

    /* --- SPIN WHEEL STYLES --- */
    #spin-wheel-card .card-body {
        background-image: linear-gradient(45deg, rgba(255, 215, 0, 0.1), transparent), linear-gradient(-45deg, rgba(0, 242, 255, 0.1), transparent);
    }

    #spin-wheel-btn {
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 0 20px var(--secondary-glow);
    }

        #spin-wheel-btn:disabled {
            box-shadow: none;
        }

    #spin-timer, #spin-attempts-text {
        font-family: monospace;
        font-size: 1.1rem;
        color: var(--secondary-glow);
        text-shadow: 0 0 8px var(--secondary-glow);
    }

    #spin-attempts-text {
        color: var(--text-color);
        text-shadow: none;
        font-size: 1rem;
    }

    #spinWheelModal .custom-modal-content {
        max-width: 480px;
        padding: 15px;
        background-color: transparent;
        border: none;
        box-shadow: none;
    }

    #spin-canvas {
        display: block;
        margin: 0 auto;
        max-width: 100%;
        height: auto;
    }

    /* --- MODAL & MISC STYLES --- */
    .custom-modal {
        display: none;
        position: fixed;
        z-index: 1060;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        background-color: rgba(11, 2, 29, 0.9);
        backdrop-filter: blur(8px);
        align-items: center;
        justify-content: center;
    }

        .custom-modal.show {
            display: flex;
        }

    .custom-modal-content:not(#spinWheelModal .custom-modal-content) {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        margin: 1rem;
        padding: 30px;
        width: 90%;
        max-width: 800px;
        border-radius: 0.75rem;
        position: relative;
        animation: modal-fade-in 0.3s ease-out;
    }

    @keyframes modal-fade-in {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .custom-close-btn {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
        z-index: 1070;
    }

        .custom-close-btn:hover {
            color: #fff;
        }

    .ticker-wrap {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        padding: 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .ticker-title {
        background-color: var(--primary-glow);
        color: white;
        padding: 5px 15px;
        border-radius: 5px;
        font-weight: bold;
        flex-shrink: 0;
    }

    .ticker-container {
        flex-grow: 1;
        overflow: hidden;
        position: relative;
        min-height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ticker-item {
        color: var(--text-color);
        font-weight: bold;
        position: absolute;
        width: 100%;
        text-align: center;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out;
        will-change: opacity, transform;
    }

        .ticker-item.active {
            opacity: 1;
            transform: translateY(0);
            z-index: 1;
        }

    /* DUEL & CRAWL STYLES */
    .duel-select {
        background-color: var(--bs-body-bg) !important;
        color: var(--bs-body-color) !important;
        border-color: var(--card-border) !important;
    }

    .duel-arena {
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        height: 250px;
        padding-top: 20px;
        overflow: hidden;
    }

    .fighter, .wrestler {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .fighter-name {
        font-weight: bold;
        font-size: 1.2rem;
        margin-bottom: 10px;
        color: var(--primary-glow);
    }

    .fighter-icon {
        font-size: 6rem;
        line-height: 1;
        color: var(--text-color);
    }

    .vs-text {
        font-size: 4rem;
        font-weight: 800;
        color: #ffc107;
        align-self: center;
        text-shadow: 0 0 10px #ffc107;
    }

    #duel-result-text, #game-status-text {
        font-size: 1.5rem;
        font-weight: bold;
        margin-top: 20px;
        height: 3rem;
    }

    .fighter.fighting .fighter-icon {
        animation: shake 0.4s infinite;
    }

    @keyframes shake {
        0% {
            transform: translate(1px,1px)
        }

        25% {
            transform: translate(-1px,-2px)
        }

        50% {
            transform: translate(-3px,0)
        }

        75% {
            transform: translate(3px,2px)
        }

        100% {
            transform: translate(1px,-1px)
        }
    }

    #crawl-chart-container {
        position: relative;
        height: 250px;
        width: 250px;
        margin: auto;
    }

    #userChartModal .custom-modal-content, #wrestlingModal .custom-modal-content {
        max-width: 800px;
    }

    #user-chart-container {
        height: 400px;
    }

    /* === WRESTLING ARENA STYLES === */
    .wrestling-arena {
        height: 300px;
        background: url('https://i.imgur.com/u7z2xKk.jpg') center center/cover;
        border-radius: 0.5rem;
        border: 2px solid var(--primary-glow);
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }

    .wrestler {
        width: 40%;
    }

    .wrestler-name {
        font-size: 1.5rem;
        color: #fff;
        text-shadow: 0 0 8px var(--primary-glow), 0 0 5px #000;
        background: rgba(0,0,0,0.6);
        padding: 5px 15px;
        border-radius: 5px;
    }

    .wrestler-icon {
        width: 120px;
        height: 160px;
        object-fit: contain;
        filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4));
        transition: transform 0.1s ease-in-out;
    }

    .wrestler.taking-damage {
        animation: take-damage 0.3s;
    }

    @keyframes take-damage {
        0%,100% {
            transform: translateX(0)
        }

        25% {
            transform: translateX(-8px) rotate(-2deg)
        }

        75% {
            transform: translateX(8px) rotate(2deg)
        }
    }

    .health-bar-container {
        width: 100%;
        max-width: 200px;
        height: 25px;
        background-color: rgba(0,0,0,0.5);
        border-radius: 8px;
        margin-bottom: 10px;
        overflow: hidden;
        border: 2px solid #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .health-bar {
        height: 100%;
        width: 100%;
        background: linear-gradient(90deg, #14f195, #00f2ff);
        border-radius: 4px;
        transition: width 0.5s ease-in-out;
    }

        .health-bar.low {
            background: linear-gradient(90deg, #ffc107, #dc3545);
        }

    #game-status-text {
        text-shadow: 0 0 10px var(--accent-glow);
    }

    #online-users-list .list-group-item {
        background-color: rgba(255,255,255,0.05);
    }

    html:not(.dark-mode) #online-users-list .list-group-item {
        background-color: rgba(0,0,0,0.02);
    }

    #online-users-list .status-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-left: 8px;
    }

        #online-users-list .status-dot.online {
            background-color: #28a745;
        }

        #online-users-list .status-dot.in-game {
            background-color: #dc3545;
        }
</style>
{% endblock %}

{% block content %}
<div id="announcements-container" class="row justify-content-center mb-4" style="display: none;">
    <div class="col-lg-12"><div class="ticker-wrap"><div class="d-flex align-items-center"><div class="ticker-title">ÿπÿßÿ¨ŸÑ</div><div class="ticker-container" id="announcements-ticker"></div></div></div></div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card shadow-lg h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-bar-chart-line-fill me-2"></i>ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿπÿßŸÖ ŸÑŸÑÿ≤Ÿàÿßÿ≠ŸÅ</span>
                <input type="search" id="searchInput" class="form-control form-control-sm w-50" placeholder="üîç ÿßÿ®ÿ≠ÿ´..." />
            </div>
            <div class="card-body table-responsive">
                <table class="table table-hover align-middle">
                    <thead><tr><th>#</th><th> ÿßÿ≥ŸÖ ÿßŸÑÿ≤ÿßÿ≠ŸÅ  </th><th class="text-center">ÿßŸÑŸÜŸÇÿßÿ∑</th><th class="text-center">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th></tr></thead>
                    <tbody id="user-table-body"><tr><td colspan="4" class="text-center py-5"><div id="loading-spinner"><div class="spinner-border text-danger"></div><p class="mt-2">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≤ÿ≠ŸÅ...</p></div></td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="vstack gap-4">

            <div class="card shadow-lg">
                <div class="card-header"><i class="bi bi-controller text-warning me-2"></i> ÿ≠ŸÑÿ®ÿ© ÿßŸÑŸÖÿµÿßÿ±ÿπÿ©</div>
                <div class="card-body">
                    <p class="text-muted small mb-3">ÿ™ÿ≠ÿØŸâ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ ÿ≠ÿßŸÑŸäÿßŸã ŸÅŸä ŸÖÿ®ÿßÿ±ÿßÿ© ŸÖÿµÿßÿ±ÿπÿ© ÿ≠Ÿäÿ© Ÿàÿßÿ±ÿ®ÿ≠ ÿßŸÑŸÜŸÇÿßÿ∑!</p>
                    <h6 class="mb-2">ÿßŸÑŸÑÿßÿπÿ®ŸàŸÜ ÿßŸÑŸÖÿ™ÿµŸÑŸàŸÜ:</h6>
                    <ul class="list-group" id="online-users-list" style="max-height: 200px; overflow-y: auto;">
                        <li class="list-group-item text-center text-muted">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÑÿßÿπÿ®ŸäŸÜ...</li>
                    </ul>
                </div>
            </div>

            <div class="card shadow-lg" id="spin-wheel-card" style="display: none;">
                <div class="card-header text-warning"><i class="bi bi-bullseye me-2"></i>ÿπÿ¨ŸÑÿ© ÿ≠ÿ∏ ÿßŸÑÿ≤Ÿàÿßÿ≠ŸÅ</div>
                <div class="card-body text-center">
                    <p class="text-muted small mb-2">ÿ¨ÿ±Ÿëÿ® ÿ≠ÿ∏ŸÉ ŸÑŸÑŸÅŸàÿ≤ ÿ®ŸÜŸÇÿßÿ∑ ŸàÿßŸÑÿ™ÿ®ÿ±ÿπ ÿ®Ÿáÿß!</p>
                    <div id="spin-attempts-text" class="mb-2 fw-bold"></div>
                    <div class="d-grid"><button class="btn btn-info" id="spin-wheel-btn"><i class="bi bi-arrow-repeat me-2"></i>ŸÑŸÅ ÿßŸÑÿπÿ¨ŸÑÿ© ÿßŸÑÿ¢ŸÜ!</button></div>
                    <div id="spin-timer-container" style="display: none;"><p class="mb-1 mt-3">ŸäŸÖŸÉŸÜŸÉ ÿßŸÑŸÑŸÅ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ®ÿπÿØ:</p><div id="spin-timer" class="fw-bold">--:--:--</div></div>
                </div>
            </div>

            <div class="card shadow-lg">
                <div class="card-header"><i class="bi bi-speedometer2 me-2 text-info"></i>ŸÉÿßÿ¥ŸÅ ÿßŸÑÿ≤Ÿàÿßÿ≠ŸÅ</div>
                <div class="card-body"><p class="text-muted small">ŸáŸÑ ÿ£ŸÜÿ™ ÿ≤ÿßÿ≠ŸÅÿü ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ŸàÿßŸÉÿ™ÿ¥ŸÅ!</p><div class="input-group"><input type="text" id="crawl-name-input" class="form-control form-control-sm" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖÿßŸã..."><button id="check-crawl-btn" class="btn btn-info btn-sm">ÿßŸÅÿ≠ÿµ</button></div></div>
            </div>

            <div class="card shadow-lg">
                <div class="card-header"><i class="bi bi-lightning-charge-fill text-warning me-2"></i>ŸÖŸàÿßÿ¨Ÿáÿßÿ™ (ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä)</div>
                <div class="card-body"><div class="mb-2"><label for="duel-user1" class="form-label small">ÿßŸÑÿ≤ÿßÿ≠ŸÅ ÿßŸÑÿ£ŸàŸÑ</label><select id="duel-user1" class="form-select form-select-sm duel-select"></select></div><div class="mb-3"><label for="duel-user2" class="form-label small">ÿßŸÑÿ≤ÿßÿ≠ŸÅ ÿßŸÑÿ´ÿßŸÜŸä</label><select id="duel-user2" class="form-select form-select-sm duel-select"></select></div><div class="d-grid"><button id="start-duel-btn" class="btn btn-warning btn-sm">ÿ®ÿØÿ° ÿßŸÑŸÖŸàÿßÿ¨Ÿáÿ©!</button></div></div>
            </div>

            <div class="card shadow-lg"><div class="card-header bg-warning text-dark"><i class="bi bi-trophy-fill me-2"></i>ÿ™Ÿàÿ® 3 ÿ≤Ÿàÿßÿ≠ŸÅ</div><ul class="list-group list-group-flush" id="hall-of-fame"></ul></div>
            <div class="card shadow-lg"><div class="card-header" style="background: var(--primary-glow); color: #fff;"><i class="bi bi-award-fill me-2"></i> ÿßŸÑÿ≤ÿßÿ≠ŸÅ ÿßŸÑÿßŸÉÿ´ÿ± ÿ∞ŸÉÿ±ÿßŸã</div><ul class="list-group list-group-flush" id="honor-roll-view-list"></ul></div>
            <div class="card shadow-lg"><div class="card-header"><i class="bi bi-person-check-fill me-2 text-success"></i>ŸÖÿ±ÿ¥ÿ≠ŸàŸÜ ŸÑŸÑÿØÿÆŸàŸÑ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© </div><ul class="list-group list-group-flush" id="candidates-list"></ul></div>
            <div class="card shadow-lg"><div class="card-header"><i class="bi bi-joystick me-2"></i>ÿ™ŸÅÿßÿπŸÑ ŸÖÿπŸÜÿß</div><div class="card-body d-grid gap-2"><button class="btn btn-success" id="nominate-btn"><i class="bi bi-person-up me-2"></i>ÿ±ÿ¥ÿ≠ ÿßÿ≠ÿØÿßŸã</button><button class="btn btn-outline-danger" id="report-btn"><i class="bi bi-exclamation-triangle-fill me-2"></i>ÿ£ÿ®ŸÑÿ∫ ÿπŸÜ ÿ≤ÿßÿ≠ŸÅ</button></div></div>
        </div>
    </div>
</div>

<!-- All Modals -->
<div id="wrestlingModal" class="custom-modal"><div class="custom-modal-content"><span class="custom-close-btn" id="close-wrestling-modal-btn">√ó</span><h3 class="mb-4 text-center text-warning" style="text-shadow: 0 0 10px var(--bs-warning);">ÿ≠ŸÑÿ®ÿ© ÿßŸÑŸÇÿ™ÿßŸÑ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±</h3><div class="wrestling-arena"><div class="wrestler" id="wrestler1"><div class="wrestler-name">ÿßŸÑŸÑÿßÿπÿ® 1</div><div class="health-bar-container"><div class="health-bar"></div></div><img src="https://i.imgur.com/7bOMuP9.png" alt="Wrestler 1" class="wrestler-icon"></div><div class="vs-text">VS</div><div class="wrestler" id="wrestler2"><div class="wrestler-name">ÿßŸÑŸÑÿßÿπÿ® 2</div><div class="health-bar-container"><div class="health-bar"></div></div><img src="https://i.imgur.com/j0v5R0b.png" alt="Wrestler 2" class="wrestler-icon"></div></div><div id="game-status-text" class="text-center mt-3"></div><div id="game-controls" class="text-center mt-3 d-grid gap-2 col-6 mx-auto" style="display: none !important;"><button class="btn btn-danger" id="attack-btn"><i class="bi bi-hammer me-2"></i> Ÿáÿ¨ŸàŸÖ </button></div></div></div>
<div id="spinWheelModal" class="custom-modal"><div class="custom-modal-content"><span class="custom-close-btn">√ó</span><canvas id="spin-canvas" width="450" height="450"></canvas></div></div>
<div id="userChartModal" class="custom-modal"><div class="custom-modal-content"><span class="custom-close-btn">√ó</span><h5 class="mb-3" id="chartModalLabel">ÿ≥ÿ¨ŸÑ ŸÜŸÇÿßÿ∑ ÿßŸÑÿ≤Ÿàÿßÿ≠ŸÅ</h5><div id="user-chart-container"><canvas id="userPointsChart"></canvas></div></div></div>
<div id="duelModal" class="custom-modal"><div class="custom-modal-content"><span class="custom-close-btn">√ó</span><h3 class="mb-4 text-center">ÿ≠ŸÑÿ®ÿ© ÿßŸÑÿ≤ÿ≠ŸÅŸÜÿ©</h3><div class="duel-arena"><div class="fighter" id="fighter1"><div class="fighter-name">ÿßŸÑÿ≤ÿßÿ≠ŸÅ 1</div><div class="health-bar-container"><div class="health-bar"></div></div><i class="bi bi-person-arms-up fighter-icon"></i></div><div class="vs-text">VS</div><div class="fighter" id="fighter2"><div class="fighter-name">ÿßŸÑÿ≤ÿßÿ≠ŸÅ 2</div><div class="health-bar-container"><div class="health-bar"></div></div><i class="bi bi-person-raised-hand fighter-icon"></i></div></div><div id="duel-result-text" class="text-center text-warning mt-3"></div></div></div>
<div id="crawlModal" class="custom-modal"><div class="custom-modal-content text-center"><span class="custom-close-btn">√ó</span><h3 class="mb-3" id="crawl-modal-title">ŸÜÿ™Ÿäÿ¨ÿ© ŸÅÿ≠ÿµ ÿßŸÑÿ≤ÿ≠ŸÅŸÜÿ©</h3><div id="crawl-chart-container"><canvas id="crawlChart"></canvas></div><p id="crawl-modal-text" class="fs-5 mt-3 fw-bold"></p></div></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
<script src="{{ url_for('static', filename='js/Winwheel.min.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- UI Elements ---
    const ui = {
        tableBody: document.getElementById('user-table-body'),
        loadingSpinner: document.getElementById('loading-spinner'),
        hallOfFame: document.getElementById('hall-of-fame'),
        honorRollList: document.getElementById('honor-roll-view-list'),
        candidatesList: document.getElementById('candidates-list'),
        searchInput: document.getElementById('searchInput'),
        nominateBtn: document.getElementById('nominate-btn'),
        reportBtn: document.getElementById('report-btn'),
        announcementsContainer: document.getElementById('announcements-container'),
        announcementsTicker: document.getElementById('announcements-ticker'),
        userChartModal: document.getElementById('userChartModal'),
        chartModalLabel: document.getElementById('chartModalLabel'),
        userPointsChartCanvas: document.getElementById('userPointsChart'),
        spinWheel: { card: document.getElementById('spin-wheel-card'), btn: document.getElementById('spin-wheel-btn'), timerContainer: document.getElementById('spin-timer-container'), timer: document.getElementById('spin-timer'), attemptsText: document.getElementById('spin-attempts-text'), modal: document.getElementById('spinWheelModal'), canvas: document.getElementById('spin-canvas'), modalCloseBtn: document.querySelector('#spinWheelModal .custom-close-btn')},
        duelModal: document.getElementById('duelModal'), duelUser1Select: document.getElementById('duel-user1'), duelUser2Select: document.getElementById('duel-user2'), startDuelBtn: document.getElementById('start-duel-btn'), fighter1Name: document.querySelector('#fighter1 .fighter-name'), fighter2Name: document.querySelector('#fighter2 .fighter-name'), fighter1Health: document.querySelector('#fighter1 .health-bar'), fighter2Health: document.querySelector('#fighter2 .health-bar'), fighter1Div: document.getElementById('fighter1'), fighter2Div: document.getElementById('fighter2'), duelResultText: document.getElementById('duel-result-text'),
        crawlModal: document.getElementById('crawlModal'), crawlNameInput: document.getElementById('crawl-name-input'), checkCrawlBtn: document.getElementById('check-crawl-btn'), crawlModalTitle: document.getElementById('crawl-modal-title'), crawlChartCanvas: document.getElementById('crawlChart'), crawlModalText: document.getElementById('crawl-modal-text'),
        onlineUsersList: document.getElementById('online-users-list'), wrestlingModal: document.getElementById('wrestlingModal'), closeWrestlingModalBtn: document.getElementById('close-wrestling-modal-btn'), wrestler1: { div: document.getElementById('wrestler1'), name: document.querySelector('#wrestler1 .wrestler-name'), healthBar: document.querySelector('#wrestler1 .health-bar'), icon: document.querySelector('#wrestler1 .wrestler-icon')}, wrestler2: { div: document.getElementById('wrestler2'), name: document.querySelector('#wrestler2 .wrestler-name'), healthBar: document.querySelector('#wrestler2 .health-bar'), icon: document.querySelector('#wrestler2 .wrestler-icon')}, gameStatusText: document.getElementById('game-status-text'), gameControls: document.getElementById('game-controls'), attackBtn: document.getElementById('attack-btn'),
    };

    // --- Global State ---
    let allUsersCache = [], honorRollCache = [], candidatesCache = [], announcementsCache = [], spinWheelSettings = null;
    let userChartInstance = null, crawlChartInstance = null, theWheel = null;
    let visitorName = '', dbInstance = null, announcementInterval = null, cooldownInterval = null;
    let wheelSpinning = false;
    let currentGame = { roomId: null, myPlayerKey: null, opponentPlayerKey: null, listener: null, isGameOver: false };
    const WRESTLING_WIN_PRIZE = 10000;

    const formatNumber = (num) => new Intl.NumberFormat('ar-EG').format(num || 0);

    async function initializeApp() {
        try {
            visitorName = localStorage.getItem('visitorNickname');
            if (!visitorName) {
                const { value: name } = await Swal.fire({ title: 'ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ!', input: 'text', inputLabel: 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ ÿßŸÑŸÖÿ≥ÿ™ÿπÿßÿ± ŸÑŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©. ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑÿ≥Ÿäÿ¶ÿ© ŸÑÿ™ŸÅÿßÿØŸä ÿßŸÑÿ≠ÿ∏ÿ±.', inputPlaceholder: 'ÿßŸÑÿßÿ≥ŸÖ...', allowOutsideClick: false, allowEscapeKey: false, inputValidator: (v) => !v && 'Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ!' });
                if (name) { visitorName = name.trim().replace(/[.#$\[\]]/g, '_'); localStorage.setItem('visitorNickname', visitorName); }
                else { window.location.reload(); return; }
            }
            const banStatus = await (await fetch(`/api/check_ban_status/${visitorName}`)).json();
            if (banStatus.is_banned) { document.body.innerHTML = `<div class="container text-center mt-5"><div class="card p-5"><h1 class="text-danger">ŸÑŸÇÿØ ÿ™ŸÖ ÿ≠ÿ∏ÿ±ŸÉ</h1></div></div>`; return; }

            spinWheelSettings = await (await fetch('/api/settings/spin_wheel')).json();
            const configStr = '{{ firebase_config|tojson|safe }}';
            if (!configStr || configStr === '{}') throw new Error("Firebase config is missing.");
            if (!firebase.apps.length) firebase.initializeApp(JSON.parse(configStr));
            dbInstance = firebase.database();

            setupEventListeners();
            if (spinWheelSettings && spinWheelSettings.enabled) {
                ui.spinWheel.card.style.display = 'block';
                if (typeof Winwheel !== 'undefined' && typeof gsap !== 'undefined') { initializeSpinWheel(); updateSpinWheelUI(); }
                else { console.error('Spin wheel libraries not loaded!'); }
            }
            setupFirebaseListeners();
        } catch (e) {
            console.error("CRITICAL INITIALIZATION ERROR:", e.message, e.stack);
            const errorContainer = ui.loadingSpinner?.parentElement || document.body;
            if (errorContainer) errorContainer.innerHTML = `<div class="alert alert-danger m-3"><strong>ÿÆÿ∑ÿ£ ÿ≠ÿ±ÿ¨:</strong> ${e.message}</div>`;
        }
    }

    function setupFirebaseListeners() {
        dbInstance.ref('users').on('value', handleUsersSnapshot, handleFirebaseError);
        dbInstance.ref('site_settings/honor_roll').on('value', handleHonorRollSnapshot, handleFirebaseError);
        dbInstance.ref('candidates').on('value', handleCandidatesSnapshot, handleFirebaseError);
        dbInstance.ref('site_settings/announcements').on('value', handleAnnouncementsSnapshot, handleFirebaseError);
        setupPresenceSystem();
        dbInstance.ref('online_users').on('value', renderOnlineUsersList);
        dbInstance.ref(`invites/${visitorName}`).on('child_added', handleIncomingInvite);
    }

    function setupPresenceSystem() {
        const myPresenceRef = dbInstance.ref(`online_users/${visitorName}`);
        dbInstance.ref('.info/connected').on('value', snap => {
            if (snap.val() === true) {
                myPresenceRef.onDisconnect().remove();
                myPresenceRef.set({ name: visitorName, status: 'online', timestamp: firebase.database.ServerValue.TIMESTAMP });
            }
        });
    }

    function handleFirebaseError(error) { console.error("Firebase Read Error:", error.code, error.message); }

    function handleUsersSnapshot(snapshot) {
        if (ui.loadingSpinner) ui.loadingSpinner.parentElement.style.display = 'none';
        const usersData = snapshot.val() || {};
        allUsersCache = Object.keys(usersData).map(k => ({ name: k, ...usersData[k] })).sort((a, b) => (b.points || 0) - (a.points || 0));
        renderUserTable();
        renderTop3();
        updateDuelSelectors();
    }

    const renderUserTable = () => { const term = ui.searchInput.value.toLowerCase(); const filtered = allUsersCache.filter(u => u.name.toLowerCase().includes(term)); ui.tableBody.innerHTML = filtered.length ? filtered.map(user => { const rank = allUsersCache.findIndex(u => u.name === user.name) + 1; const honorBadge = honorRollCache.includes(user.name) ? ` <span class="badge rounded-pill" style="background:var(--primary-glow);color:#fff;"><i class="bi bi-award-fill"></i></span>` : ''; const hasLiked = new Set(JSON.parse(localStorage.getItem('likedUsers') || '[]')).has(user.name); return `<tr><th class="align-middle">#${rank}</th><td class="align-middle fw-bold">${user.name}${honorBadge}</td><td class="text-center align-middle fs-5 fw-bold">${formatNumber(user.points)}</td><td class="text-center align-middle"><button class="btn btn-sm like-btn ${hasLiked ? 'liked' : 'btn-outline-danger'}" data-username="${user.name}"><i class="bi bi-heart-fill"></i> <span class="like-count">${formatNumber(user.likes)}</span></button><button class="btn btn-sm btn-outline-info ms-2 chart-btn" data-username="${user.name}" title="ÿπÿ±ÿ∂ ÿ™ŸÇÿØŸÖ ÿßŸÑÿ≤ÿßÿ≠ŸÅ"><i class="bi bi-graph-up-arrow"></i></button></td></tr>`; }).join('') : `<tr><td colspan="4" class="text-center py-4">${term ? 'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≤ÿßÿ≠ŸÅ Ÿäÿ∑ÿßÿ®ŸÇ ÿßŸÑÿ®ÿ≠ÿ´.' : 'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™.'}</td></tr>`; };
    const handleHonorRollSnapshot = (s) => { honorRollCache = Object.values(s.val() || {}).map(i => i.name); renderHonorRollList(); };
    const handleCandidatesSnapshot = (s) => { candidatesCache = Object.keys(s.val() || {}); renderCandidatesList(); };
    const handleAnnouncementsSnapshot = (s) => { announcementsCache = Object.values(s.val() || {}); renderAnnouncements(); };
    const renderTop3 = () => { ui.hallOfFame.innerHTML = allUsersCache.slice(0, 3).map((u, i) => `<li class="list-group-item d-flex justify-content-between"><span>${['ü•á','ü•à','ü•â'][i]} ${u.name}</span><span class="badge rounded-pill" style="background-color:var(--primary-glow)">${formatNumber(u.points)}</span></li>`).join('') || `<li class="list-group-item text-muted text-center">ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÅÿßÿ±ÿ∫ÿ©.</li>`; };
    const renderHonorRollList = () => { ui.honorRollList.innerHTML = honorRollCache.length ? honorRollCache.map(n => `<li class="list-group-item fw-bold text-center"><i class="bi bi-star-fill text-warning me-2"></i>${n}</li>`).join('') : `<li class="list-group-item text-muted text-center">ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÅÿßÿ±ÿ∫ÿ©.</li>`; };
    const renderCandidatesList = () => { ui.candidatesList.innerHTML = candidatesCache.length ? candidatesCache.map(n => `<li class="list-group-item"><i class="bi bi-person-check-fill me-2"></i>${n}</li>`).join('') : `<li class="list-group-item text-muted text-center">ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ±ÿ¥ÿ≠ŸàŸÜ.</li>`; };
    const renderAnnouncements = () => { if (!ui.announcementsTicker) return; ui.announcementsTicker.innerHTML = ''; if (announcementInterval) clearInterval(announcementInterval); if (announcementsCache.length > 0) { ui.announcementsContainer.style.display = 'block'; announcementsCache.forEach(ann => { const item = document.createElement('div'); item.className = 'ticker-item'; item.textContent = ann.text; ui.announcementsTicker.appendChild(item); }); const items = ui.announcementsTicker.querySelectorAll('.ticker-item'); if (items.length === 0) return; let i = 0; if(items[i]) items[i].classList.add('active'); if (items.length > 1) { announcementInterval = setInterval(() => { if(items[i]) items[i].classList.remove('active'); i = (i + 1) % items.length; if(items[i]) items[i].classList.add('active'); }, 5000); } } else { ui.announcementsContainer.style.display = 'none'; } };
    const updateDuelSelectors = () => { if (!ui.duelUser1Select) return; const opts = allUsersCache.map(u => `<option value="${u.name}">${u.name}</option>`).join(''); ui.duelUser1Select.innerHTML = opts; ui.duelUser2Select.innerHTML = opts; if (allUsersCache.length > 1) ui.duelUser2Select.selectedIndex = 1; };

    const renderOnlineUsersList = (snapshot) => { const onlineUsers = Object.values(snapshot.val() || {}); ui.onlineUsersList.innerHTML = (onlineUsers.length <= 1) ? `<li class="list-group-item text-center text-muted">ŸÑÿß ŸäŸàÿ¨ÿØ ŸÑÿßÿπÿ®ŸàŸÜ ÿ¢ÿÆÿ±ŸàŸÜ.</li>` : onlineUsers.filter(u => u.name !== visitorName).map(u => { const isAvailable = u.status === 'online'; return `<li class="list-group-item d-flex justify-content-between align-items-center"><div><span class="status-dot ${isAvailable ? 'online' : 'in-game'}"></span><span class="fw-bold">${u.name}</span>${!isAvailable ? '<small class="text-muted ms-2">(ŸÅŸä ŸÖÿπÿ±ŸÉÿ©)</small>' : ''}</div><button class="btn btn-sm btn-warning challenge-btn" data-target-user="${u.name}" ${!isAvailable ? 'disabled' : ''}><i class="bi bi-shield-shaded"></i> ÿ™ÿ≠ÿØŸä</button></li>`; }).join(''); };
    function sendChallenge(targetUserName) { if (targetUserName === visitorName) return; const inviteRef = dbInstance.ref(`invites/${targetUserName}/${visitorName}`); inviteRef.set({ from: visitorName, timestamp: firebase.database.ServerValue.TIMESTAMP }); Swal.fire({ title: 'ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ™ÿ≠ÿØŸä!', text: `ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ±ÿØ ŸÖŸÜ ${targetUserName}...`, allowOutsideClick: false, showConfirmButton: false, timer: 20000, willClose: () => inviteRef.remove() }); const roomId = [visitorName, targetUserName].sort().join('-vs-'); const gameRoomRef = dbInstance.ref(`game_rooms/${roomId}`); gameRoomRef.on('value', s => { if (s.exists()) { Swal.close(); gameRoomRef.off('value'); enterGame(roomId, 'player1'); } }); }
    function handleIncomingInvite(snapshot) { const { from: inviterName } = snapshot.val() || {}; if (!inviterName) return; const inviteRef = snapshot.ref; Swal.fire({ title: 'ÿ™ÿ≠ÿØŸä ÿ¨ÿØŸäÿØ!', text: `${inviterName} Ÿäÿ™ÿ≠ÿØÿßŸÉ!`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#28a745', confirmButtonText: 'ÿßŸÇÿ®ŸÑ!', cancelButtonText: 'ÿ±ŸÅÿ∂' }).then(result => { if (result.isConfirmed) { const roomId = [visitorName, inviterName].sort().join('-vs-'); dbInstance.ref(`game_rooms/${roomId}`).set({ player1: { name: inviterName, health: 100 }, player2: { name: visitorName, health: 100 }, turn: inviterName, status: 'active' }).then(() => { dbInstance.ref(`online_users/${visitorName}/status`).set('in-game'); dbInstance.ref(`online_users/${inviterName}/status`).set('in-game'); enterGame(roomId, 'player2'); }); } inviteRef.remove(); }); }
    function enterGame(roomId, myPlayerKey) { currentGame = { roomId, myPlayerKey, opponentPlayerKey: (myPlayerKey === 'player1' ? 'player2' : 'player1'), listener: null, isGameOver: false }; const gameRoomRef = dbInstance.ref(`game_rooms/${roomId}`); currentGame.listener = gameRoomRef.on('value', updateGameUI); ui.wrestlingModal.classList.add('show'); }
    function updateGameUI(snapshot) { if (currentGame.isGameOver) return; const gameState = snapshot.val(); if (!gameState || gameState.status === 'finished') { currentGame.isGameOver = true; handleGameEnd(gameState); return; } ui.wrestler1.name.textContent = gameState.player1.name; ui.wrestler2.name.textContent = gameState.player2.name; updateHealthBar(ui.wrestler1, gameState.player1.health); updateHealthBar(ui.wrestler2, gameState.player2.health); const isMyTurn = (gameState.turn === visitorName); ui.gameStatusText.textContent = isMyTurn ? "ÿØŸàÿ±ŸÉ ŸÑŸÑŸáÿ¨ŸàŸÖ!" : `ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± Ÿáÿ¨ŸàŸÖ ${gameState.turn}...`; ui.attackBtn.disabled = !isMyTurn; ui.gameControls.style.display = 'grid'; }
    function handleGameEnd(gameState) { ui.gameControls.style.display = 'none'; if (!gameState) { Swal.fire('ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÖÿπÿ±ŸÉÿ©', 'ÿ™ŸÖ ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖÿπÿ±ŸÉÿ© ÿ£Ÿà ŸÇÿ∑ÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ.', 'info').then(leaveGame); return; } const isWinner = gameState.winner === visitorName; ui.gameStatusText.innerHTML = `üèÜ ÿßŸÑŸÅÿßÿ¶ÿ≤ ŸáŸà: <strong class="text-warning">${gameState.winner}</strong> üèÜ`; if (isWinner) { showWinnerDonationDialog(gameState.winner); } else { Swal.fire('ŸÑŸÇÿØ ÿÆÿ≥ÿ±ÿ™!', 'ÿ≠ÿ∏ÿßŸã ÿ£ŸàŸÅÿ± ŸÅŸä ÿßŸÑŸÖÿ±ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©.', 'error').then(leaveGame); } }
    function showWinnerDonationDialog(winnerName) { const opts = allUsersCache.map(u => `<option value="${u.name}">${u.name}</option>`).join(''); Swal.fire({ title: `üéâ ŸÖÿ®ÿ±ŸàŸÉ ÿßŸÑŸÅŸàÿ≤! üéâ`, html: `<div>ŸÑŸÇÿØ ÿ±ÿ®ÿ≠ÿ™ <strong class="text-warning">${formatNumber(WRESTLING_WIN_PRIZE)}</strong> ŸÜŸÇÿ∑ÿ©!</div><div class="mt-3">ÿßÿÆÿ™ÿ± ÿ≤ÿßÿ≠ŸÅÿßŸã ŸÑÿ™ŸáÿØŸäŸá Ÿáÿ∞Ÿá ÿßŸÑŸÜŸÇÿßÿ∑:</div><select id="swal-donate-select" class="swal2-select mt-2">${opts}</select>`, confirmButtonText: 'ÿ•ŸáÿØÿßÿ° ÿßŸÑŸÜŸÇÿßÿ∑!', showCancelButton: true, cancelButtonText: 'ŸÑÿß ÿ¥ŸÉÿ±ÿßŸã', didOpen: () => { if (allUsersCache.length === 0) Swal.getConfirmButton().disabled = true; }, preConfirm: () => document.getElementById('swal-donate-select').value }).then(async (result) => { if (result.isConfirmed && result.value) { try { await fetch('/api/award_wrestling_points', { method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: new URLSearchParams({ username: result.value, points: WRESTLING_WIN_PRIZE, winner_name: winnerName }) }); } catch(e){ console.error(e); } } leaveGame(); }); }
    function updateHealthBar(wrestlerUI, health) { const pct = Math.max(0, health); wrestlerUI.healthBar.style.width = `${pct}%`; wrestlerUI.healthBar.classList.toggle('low', pct < 40); const oldHealth = parseInt(wrestlerUI.div.dataset.health || "100"); if(health < oldHealth) { wrestlerUI.div.classList.add('taking-damage'); setTimeout(() => wrestlerUI.div.classList.remove('taking-damage'), 300); } wrestlerUI.div.dataset.health = health; }
    function performAttack() { if (!currentGame.roomId || ui.attackBtn.disabled) return; ui.attackBtn.disabled = true; const oppHealthRef = dbInstance.ref(`game_rooms/${currentGame.roomId}/${currentGame.opponentPlayerKey}/health`); const oppName = ui[currentGame.opponentPlayerKey].name.textContent; oppHealthRef.transaction(currentHealth => { if (currentHealth === null) return 100; const damage = Math.floor(Math.random() * 15) + 5; const newHealth = currentHealth - damage; if (newHealth <= 0) { dbInstance.ref(`game_rooms/${currentGame.roomId}`).update({ status: 'finished', winner: visitorName, turn: null }); return 0; } else { dbInstance.ref(`game_rooms/${currentGame.roomId}/turn`).set(oppName); return newHealth; } }); }
    function leaveGame() { if (!currentGame.roomId) return; const gameRoomRef = dbInstance.ref(`game_rooms/${currentGame.roomId}`); if(currentGame.listener) gameRoomRef.off('value', currentGame.listener); gameRoomRef.remove(); dbInstance.ref(`online_users/${visitorName}/status`).set('online'); ui.wrestlingModal.classList.remove('show'); currentGame = { roomId: null, myPlayerKey: null, opponentPlayerKey: null, listener: null, isGameOver: false }; }

    function initializeSpinWheel() { if (!ui.spinWheel.canvas || !spinWheelSettings) return; const segments = spinWheelSettings.prizes.map((p, i) => ({ 'fillStyle': ['#eae56f', '#7de6ef', '#89f26e', '#e7706f', '#c789f2', '#f2a15f', '#6aaff2', '#f289b4'][i % 8], 'text': p.value > 999999 ? "ŸÖŸÑŸäŸàŸÜ!" : p.value.toLocaleString('en-US'), 'textFillStyle': ['#000', '#000', '#000', '#fff', '#fff', '#000', '#fff', '#fff'][i % 8] })); try { theWheel = new Winwheel({ 'canvasId': ui.spinWheel.canvas.id, 'numSegments': segments.length, 'outerRadius': 212, 'textFontSize': 22, 'textFontWeight': 'bold', 'segments': segments, 'animation': { 'type': 'spinToStop', 'duration': 8, 'spins': 10, 'callbackFinished': handleSpinFinish, 'easing': 'Power4.easeOut' }, 'pins': { 'number': segments.length * 2, 'fillStyle': 'silver', 'outerRadius': 4, 'margin': 5 } }); } catch (e) { console.error("Error initializing Winwheel:", e); } }
    const getWinwheelState = () => JSON.parse(localStorage.getItem('winwheelState') || '{"lastReset":0,"attemptsUsed":0}');
    const saveWinwheelState = (state) => localStorage.setItem('winwheelState', JSON.stringify(state));
    async function handleSpinStart() { if (wheelSpinning || !theWheel || allUsersCache.length === 0) return; ui.spinWheel.btn.disabled = true; ui.spinWheel.btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`; try { const res = await fetch('/api/spin_wheel', { method: 'POST' }); const data = await res.json(); if (!res.ok || !data.success) throw new Error(data.message || `Server error`); let state = getWinwheelState(); state.attemptsUsed++; saveWinwheelState(state); updateSpinWheelUI(); let prizeIndex = theWheel.segments.findIndex(s => s && parseInt(s.text.replace(/,/g, '').replace('ŸÖŸÑŸäŸàŸÜ!', '1000000')) === data.prize); if(prizeIndex === -1) prizeIndex = 1; theWheel.animation.stopAngle = theWheel.getRandomForSegment(prizeIndex); wheelSpinning = true; theWheel.startAnimation(); ui.spinWheel.modal.classList.add('show'); if(ui.spinWheel.modalCloseBtn) ui.spinWheel.modalCloseBtn.style.display = 'none'; } catch (error) { Swal.fire('ÿÆÿ∑ÿ£', error.message, 'error'); resetSpinButton(); } }
    function handleSpinFinish(indicatedSegment) { wheelSpinning = false; if(ui.spinWheel.modalCloseBtn) ui.spinWheel.modalCloseBtn.style.display = 'block'; const prizeText = indicatedSegment.text.replace(/,/g, ''); const prizeWon = (prizeText === 'ŸÖŸÑŸäŸàŸÜ!') ? 1000000 : parseInt(prizeText); const opts = allUsersCache.map(u => `<option value="${u.name}">${u.name}</option>`).join(''); Swal.fire({ title: `üéâ ŸÅÿ≤ÿ™ ÿ®ŸÄ ${formatNumber(prizeWon)} ŸÜŸÇÿ∑ÿ©! üéâ`, html: `<div>ÿßÿÆÿ™ÿ± ÿ≤ÿßÿ≠ŸÅÿßŸã ŸÑŸÑÿ™ÿ®ÿ±ÿπ ŸÑŸá:</div><select id="swal-donate-select" class="swal2-select mt-3">${opts}</select>`, confirmButtonText: 'ÿ™ÿ®ÿ±ÿπ!', showCancelButton: true, didOpen: () => {if(!allUsersCache.length) Swal.getConfirmButton().disabled = true;}, preConfirm: () => document.getElementById('swal-donate-select').value }).then(async (result) => { if (result.isConfirmed && result.value) { try { await fetch('/api/donate_points', { method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: new URLSearchParams({ username: result.value, points: prizeWon, visitor_name: visitorName }) }); } catch(e){ console.error(e); } } resetSpinButton(); updateSpinWheelUI(); }); }
    function updateSpinWheelUI() { if (!spinWheelSettings) return; if(cooldownInterval) clearInterval(cooldownInterval); let state = getWinwheelState(); const cooldownMillis = spinWheelSettings.cooldownHours * 60 * 60 * 1000; if (Date.now() - state.lastReset >= cooldownMillis) { state = { lastReset: Date.now(), attemptsUsed: 0 }; saveWinwheelState(state); } const attemptsLeft = spinWheelSettings.maxAttempts - state.attemptsUsed; ui.spinWheel.attemptsText.textContent = `ŸÑÿØŸäŸÉ ${attemptsLeft} / ${spinWheelSettings.maxAttempts} ŸÖÿ≠ÿßŸàŸÑÿßÿ™`; if (attemptsLeft > 0) { ui.spinWheel.btn.disabled = false; ui.spinWheel.btn.style.display = 'block'; ui.spinWheel.timerContainer.style.display = 'none'; resetSpinButton(); } else { ui.spinWheel.btn.style.display = 'none'; ui.spinWheel.timerContainer.style.display = 'block'; let timeLeft = cooldownMillis - (Date.now() - state.lastReset); const updateTimer = () => { timeLeft -= 1000; if (timeLeft <= 0) { clearInterval(cooldownInterval); updateSpinWheelUI(); return; } const h = Math.floor(timeLeft / 36e5).toString().padStart(2,'0'), m = Math.floor((timeLeft/6e4)%60).toString().padStart(2,'0'), s = Math.floor((timeLeft/1e3)%60).toString().padStart(2,'0'); if(ui.spinWheel.timer) ui.spinWheel.timer.textContent = `${h}:${m}:${s}`; }; updateTimer(); cooldownInterval = setInterval(updateTimer, 1000); } }
    const resetSpinButton = () => { if (ui.spinWheel.btn) { ui.spinWheel.btn.disabled = false; ui.spinWheel.btn.innerHTML = `<i class="bi bi-arrow-repeat me-2"></i>ŸÑŸÅ ÿßŸÑÿπÿ¨ŸÑÿ©!`; } };

    function handleCrawlCheck() { const name = ui.crawlNameInput.value.trim(); if (!name) return; let percentage, title, text, color; const existingUser = allUsersCache.find(u => u.name.toLowerCase() === name.toLowerCase()); if (existingUser) { const maxPoints = Math.max(...allUsersCache.map(u => u.points || 0), 1); percentage = Math.min(Math.round((existingUser.points / maxPoints) * 100), 100); title = `ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ≤ÿßÿ≠ŸÅ: ${existingUser.name}`; text = `ÿ≤ÿßÿ≠ŸÅ ŸÖÿπÿ™ŸÖÿØ ÿ®ŸÜÿ≥ÿ®ÿ© ${percentage}%.`; color = '#8e44ad'; } else { let hash = 0; for (let i = 0; i < name.length; i++) { hash = name.charCodeAt(i) + ((hash << 5) - hash); } percentage = Math.abs(hash % 100) + 1; title = `ŸÜÿ™Ÿäÿ¨ÿ© ŸÅÿ≠ÿµ: "${name}"`; if (percentage < 30) { text = `ŸÜÿ≥ÿ®ÿ© ÿ≤ÿ≠ŸÅŸÉ ${percentage}%. ŸÖÿ®ÿ™ÿØÿ¶!`; color = '#2ecc71'; } else if (percentage < 70) { text = `ŸÜÿ≥ÿ®ÿ© ÿ≤ÿ≠ŸÅŸÉ ${percentage}%. ŸÖÿ≠ÿ™ÿ±ŸÅ!`; color = '#f1c40f'; } else { text = `ŸÜÿ≥ÿ®ÿ© ÿ≤ÿ≠ŸÅŸÉ ${percentage}%. ÿÆÿ∑ÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿ¨ÿ™ŸÖÿπ!`; color = '#e74c3c'; } } if (crawlChartInstance) crawlChartInstance.destroy(); ui.crawlModal.classList.add('show'); crawlChartInstance = new Chart(ui.crawlChartCanvas.getContext('2d'), { type: 'doughnut', data: { datasets: [{ data: [percentage, 100 - percentage], backgroundColor: [color, 'rgba(255,255,255,0.1)'], borderWidth: 0 }] }, options: { animation: { animateRotate: true }, cutout: '70%', plugins: { legend: { display: false } } } }); ui.crawlModalTitle.textContent = title; ui.crawlModalText.textContent = text; ui.crawlModalText.style.color = color; }
    function handleDuelStart() { const name1 = ui.duelUser1Select.value, name2 = ui.duelUser2Select.value; if (!name1 || !name2 || name1 === name2) return; ui.fighter1Name.textContent = name1; ui.fighter2Name.textContent = name2; ui.fighter1Health.style.width = '100%'; ui.fighter2Health.style.width = '100%'; ui.duelResultText.textContent = ''; ui.duelModal.classList.add('show'); const winner = Math.random() < 0.5 ? 1 : 2; setTimeout(() => { ui.fighter1Div.classList.add('fighting'); ui.fighter2Div.classList.add('fighting'); winner === 1 ? ui.fighter2Health.style.width = '0%' : ui.fighter1Health.style.width = '0%'; }, 500); setTimeout(() => { ui.fighter1Div.classList.remove('fighting'); ui.fighter2Div.classList.remove('fighting'); ui.duelResultText.innerHTML = `üèÜ ÿßŸÑŸÅÿßÿ¶ÿ≤ ŸáŸà: <strong>${winner === 1 ? name1 : name2}</strong> üèÜ`; }, 2500); }
    function showUserHistoryChart(username) { /* ... unchanged ... */ }

    function setupEventListeners() {
        ui.searchInput.addEventListener('input', renderUserTable);
        ui.tableBody.addEventListener('click', e => {
            const likeBtn = e.target.closest('.like-btn');
            if (likeBtn) { const username = likeBtn.dataset.username; const likedUsers = new Set(JSON.parse(localStorage.getItem('likedUsers') || '[]')); const action = likedUsers.has(username) ? 'unlike' : 'like'; if (action === 'like') { likedUsers.add(username); } else { likedUsers.delete(username); } localStorage.setItem('likedUsers', JSON.stringify([...likedUsers])); renderUserTable(); fetch(`/like/${username}?action=${action}`, { method:'POST', body: new URLSearchParams({visitor_name: visitorName}) }); }
            if (e.target.closest('.chart-btn')) { showUserHistoryChart(e.target.closest('.chart-btn').dataset.username); }
        });
        ui.onlineUsersList.addEventListener('click', e => { if (e.target.closest('.challenge-btn')) sendChallenge(e.target.closest('.challenge-btn').dataset.targetUser); });
        ui.attackBtn.addEventListener('click', performAttack);
        ui.closeWrestlingModalBtn.addEventListener('click', () => { Swal.fire({ title: 'ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü', text: "ÿßŸÑŸáÿ±Ÿàÿ® ŸäÿπŸÜŸä ÿßŸÑÿÆÿ≥ÿßÿ±ÿ©!", icon: 'warning', showCancelButton: true, confirmButtonText: 'ŸÜÿπŸÖÿå ÿ£Ÿáÿ±ÿ®!' }).then(r => { if (r.isConfirmed && currentGame.roomId) { dbInstance.ref(`game_rooms/${currentGame.roomId}`).update({ status: 'finished', winner: ui[currentGame.opponentPlayerKey].name.textContent }); } }); });
        if (ui.spinWheel.btn) ui.spinWheel.btn.addEventListener('click', handleSpinStart);
        if (ui.checkCrawlBtn) ui.checkCrawlBtn.addEventListener('click', handleCrawlCheck);
        if (ui.startDuelBtn) ui.startDuelBtn.addEventListener('click', handleDuelStart);
        document.querySelectorAll('.custom-modal .custom-close-btn').forEach(btn => { if(btn.id !== 'close-wrestling-modal-btn') btn.addEventListener('click', e => e.target.closest('.custom-modal').classList.remove('show')); });
        window.addEventListener('click', e => { if (e.target.classList.contains('custom-modal') && e.target.id !== 'wrestlingModal') e.target.classList.remove('show'); });
    }
    initializeApp();
});
</script>
{% endblock %}
<!-- END OF FILE user_view.html -->
